#!/bin/bash
# mount_zo - Helper script to mount Zo Computer workspace

set -e

# Colors
RED='\033[0;31m'
# Mount filesystem
mount_filesystem() {
    local os=$(detect_os)
    
    echo -e "${CYAN}Mounting workspace...${RESET}"
    
    # Create mount point if it doesn't exist
    mkdir -p "$ZO_MOUNT_POINT"
    
    case $os in
        macos)
            # macOS uses mount_webdav
            if mount | grep -q "$ZO_MOUNT_POINT"; then
                echo -e "${YELLOW}Already mounted at $ZO_MOUNT_POINT${RESET}"
                return 0
            fi
            
            mount_webdav -s http://localhost:$ZO_MOUNT_PORT "$ZO_MOUNT_POINT" 2>/dev/null || {
                echo -e "${RED}✗ Mount failed${RESET}"
                echo "Try manually: mount_webdav http://localhost:$ZO_MOUNT_PORT $ZO_MOUNT_POINT"
                exit 1
            }
            ;;
            
        linux)
            # Linux uses davfs2
            if ! command -v mount.davfs &> /dev/null; then
                echo -e "${YELLOW}Installing davfs2...${RESET}"
                sudo apt-get update && sudo apt-get install -y davfs2 || {
                    echo -e "${RED}Failed to install davfs2${RESET}"
                    echo "Install manually: sudo apt-get install davfs2"
                    exit 1
                }
            fi
            
            if mount | grep -q "$ZO_MOUNT_POINT"; then
                echo -e "${YELLOW}Already mounted at $ZO_MOUNT_POINT${RESET}"
                return 0
            fi
            
            # Configure davfs2 to skip authentication (our server doesn't use HTTP auth)
            DAVFS_CONF="/tmp/zoMount_davfs.conf"
            cat > "$DAVFS_CONF" << 'EOF'
# Temporary davfs2 config for zoMount
use_locks 0
ask_auth 0
secrets /tmp/zoMount_secrets
EOF
            
            # Create empty secrets file
            touch /tmp/zoMount_secrets
            chmod 600 /tmp/zoMount_secrets
            
            # Mount using davfs2 with custom config
            echo -e "${YELLOW}Mounting (you may need to enter sudo password)...${RESET}"
            
            # Set trap to cleanup on failure
            cleanup_on_fail() {
                echo -e "${RED}Mount failed, cleaning up...${RESET}"
                # Kill the server we just started
                if [ -f /tmp/zoMount.pid ]; then
                    PID=$(cat /tmp/zoMount.pid)
                    kill $PID 2>/dev/null || true
                    rm /tmp/zoMount.pid 2>/dev/null || true
                fi
            }
            
            if ! sudo mount -t davfs -o conf="$DAVFS_CONF",uid=$(id -u),gid=$(id -g) \
                http://localhost:$ZO_MOUNT_PORT "$ZO_MOUNT_POINT" 2>&1; then
                cleanup_on_fail
                echo -e "${RED}✗ Mount failed${RESET}"
                echo ""
                echo -e "${YELLOW}Troubleshooting:${RESET}"
                echo "1. Check server logs: tail /tmp/zoMount.log"
                echo "2. Make sure server is running: curl http://localhost:9999/"
                echo "3. Try restarting: ./mount_zo unmount && ./mount_zo mount"
                exit 1
            fi
            ;;
            
        windows)
            # Windows uses net use with WebClient service
            echo -e "${CYAN}Checking WebClient service...${RESET}"
            
            # Check if WebClient service is running
            if ! sc query WebClient | grep -q "RUNNING"; then
                echo -e "${YELLOW}Starting WebClient service...${RESET}"
                net start WebClient 2>/dev/null || {
                    echo -e "${RED}Failed to start WebClient service${RESET}"
                    echo "Run as Administrator: net start WebClient"
                    exit 1
                }
            fi
            
            # Check Registry for BasicAuthLevel (Required for HTTP WebDAV)
            echo -e "${CYAN}Checking Windows Registry...${RESET}"
            REG_CHECK=$(reg query "HKLM\SYSTEM\CurrentControlSet\Services\WebClient\Parameters" //v BasicAuthLevel 2>/dev/null | grep "0x2")
            if [ -z "$REG_CHECK" ]; then
                echo -e "${YELLOW}⚠ Warning: Windows restricts WebDAV over HTTP by default.${RESET}"
                echo -e "${YELLOW}You need to set BasicAuthLevel to 2 in the Registry.${RESET}"
                echo ""
                echo -e "${BOLD}Run this command in Administrator PowerShell:${RESET}"
                echo -e "Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\WebClient\Parameters' -Name 'BasicAuthLevel' -Value 2"
                echo -e "Restart-Service WebClient"
                echo ""
                echo -e "Attempting to mount anyway..."
            fi
            
            echo -e "${CYAN}Mounting to Z: drive...${RESET}"
            
            # Use 127.0.0.1 instead of localhost (more reliable on Windows)
            MOUNT_URL="http://127.0.0.1:$ZO_MOUNT_PORT"
            
            # Try to mount
            # Note: We use empty username/password to prevent prompt
            if net use Z: "$MOUNT_URL" /user:dummy dummy 2>&1 | tee /tmp/mount_output.txt | grep -q "successfully\|command completed"; then
                # Verify mount actually worked
                sleep 2
                if net use | grep -q "Z:"; then
                    ZO_MOUNT_POINT="Z:"
                    echo -e "${GREEN}✓ Successfully mounted to Z:${RESET}"
                    
                    # Test if we can actually list files
                    if ls Z: > /dev/null 2>&1; then
                        echo -e "${GREEN}✓ Mount verified - files accessible${RESET}"
                    else
                        echo -e "${YELLOW}⚠ Mount succeeded but files not immediately accessible${RESET}"
                        echo -e "${DIM}Try: dir Z:${RESET}"
                    fi
                else
                    echo -e "${RED}✗ Mount command succeeded but drive not visible${RESET}"
                    cat /tmp/mount_output.txt
                    exit 1
                fi
            else
                echo -e "${RED}✗ Mount failed${RESET}"
                echo ""
                echo -e "${YELLOW}Error output:${RESET}"
                cat /tmp/mount_output.txt
                echo ""
                echo -e "${YELLOW}Troubleshooting:${RESET}"
                echo "1. Registry: Ensure BasicAuthLevel is set to 2 (see warning above)"
                echo "2. Service: Ensure WebClient is running"
                echo "3. Manual: net use Z: $MOUNT_URL /user:dummy dummy"
                exit 1
            fi
            ;;
            
        *)
            echo -e "${RED}Unsupported OS${RESET}"
            exit 1
            ;;
    esac
    
    echo ""
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
    echo -e "${GREEN}✓ Workspace successfully mounted!${RESET}"
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
    echo -e "  Mount point: ${BOLD}$ZO_MOUNT_POINT${RESET}"
    echo -e "  Server: http://localhost:$ZO_MOUNT_PORT"
    echo ""
}

# Unmount filesystem
unmount_filesystem() {
    local os=$(detect_os)
    
    echo -e "${CYAN}Unmounting workspace...${RESET}"
    
    case $os in
        macos)
            if mount | grep -q "$ZO_MOUNT_POINT"; then
                umount "$ZO_MOUNT_POINT" 2>/dev/null || {
                    echo -e "${RED}✗ Unmount failed${RESET}"
                    exit 1
                }
            fi
            ;;
            
        linux)
            if mount | grep -q "$ZO_MOUNT_POINT"; then
                sudo umount "$ZO_MOUNT_POINT" 2>/dev/null || {
                    echo -e "${RED}✗ Unmount failed${RESET}"
                    exit 1
                }
            fi
            ;;
            
        windows)
            net use Z: /delete 2>/dev/null || true
            ;;
    esac
    
    echo -e "${GREEN}✓ Unmounted${RESET}"
}

# Stop server
stop_server() {
    if [ -f /tmp/zoMount.pid ]; then
        PID=$(cat /tmp/zoMount.pid)
        if ps -p $PID > /dev/null 2>&1; then
            echo -e "${CYAN}Stopping server (PID: $PID)...${RESET}"
            kill $PID 2>/dev/null || true
            rm /tmp/zoMount.pid
            echo -e "${GREEN}✓ Server stopped${RESET}"
        fi
    fi
}

# Main command handler
case "${1:-mount}" in
    mount)
        # Check if we're running inside Zo Computer
        if check_zo_computer_environment; then
            clear
            echo -e "${RED}"
            cat << "ERROR"
     ██████╗ ██╗  ██╗    ███╗   ██╗ ██████╗ 
    ██╔═══██╗██║  ██║    ████╗  ██║██╔═══██╗
    ██║   ██║███████║    ██╔██╗ ██║██║   ██║
    ██║   ██║██╔══██║    ██║╚██╗██║██║   ██║
    ╚██████╔╝██║  ██║    ██║ ╚████║╚██████╔╝
     ╚═════╝ ╚═╝  ╚═╝    ╚═╝  ╚═══╝ ╚═════╝ 
ERROR
            echo -e "${RESET}"
            echo ""
            echo -e "${BOLD}${RED}Cannot Mount From Zo Computer VPS!${RESET}"
            echo ""
            echo -e "${YELLOW}This feature is designed for mounting your Zo Computer workspace"
            echo -e "onto your ${BOLD}local machine${RESET}${YELLOW} (Windows, macOS, Linux laptop/desktop).${RESET}"
            echo ""
            echo -e "You are currently ${RED}inside${RESET} your Zo Computer VPS environment."
            echo -e "Mounting the workspace onto itself doesn't make sense!"
            echo ""
            echo -e "${CYAN}To use this feature:${RESET}"
            echo -e "  1. Exit your SSH session (type 'exit')"
            echo -e "  2. Run zochat on your ${BOLD}local machine${RESET}"
            echo -e "  3. Select [8] Mount"
            echo ""
            exit 1
        fi
        
        if is_server_running; then
            echo -e "${GREEN}Server is already running${RESET}"
        else
            start_server
        fi
        mount_filesystem
        echo ""
        echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
        echo -e "${BOLD}  Zo Computer workspace mounted!${RESET}"
        echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
        echo ""
        echo -e "  ${CYAN}Mount point:${RESET} $ZO_MOUNT_POINT"
        echo -e "  ${CYAN}Status:${RESET}      $(mount | grep $ZO_MOUNT_POINT | head -1)"
        echo ""
        echo -e "${YELLOW}To unmount:${RESET} ./mount_zo unmount"
        echo ""
        ;;
        
    unmount)
        unmount_filesystem
        stop_server
        ;;
        
    status)
        if is_server_running; then
            echo -e "${GREEN}✓ Server is running on port $ZO_MOUNT_PORT${RESET}"
            if mount | grep -q "$ZO_MOUNT_POINT"; then
                echo -e "${GREEN}✓ Mounted at $ZO_MOUNT_POINT${RESET}"
            else
                echo -e "${YELLOW}⚠ Server running but not mounted${RESET}"
            fi
        else
            echo -e "${RED}✗ Server is not running${RESET}"
        fi
        ;;
        
    *)
        echo "Usage: $0 {mount|unmount|status}"
        exit 1
        ;;
esac
