#!/bin/bash
# mount_zo - Helper script to mount Zo Computer workspace

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
RESET='\033[0m'

# Configuration
ZO_MOUNT_PORT=9999
ZO_MOUNT_POINT="$HOME/zoMount"
SERVER_SCRIPT="$(dirname "$0")/zoMount"

# Detect OS
detect_os() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        echo "macos"
    elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
        echo "linux"
    elif [[ "$OSTYPE" == "msys" ]] || [[ "$OSTYPE" == "cygwin" ]]; then
        echo "windows"
    else
        echo "unknown"
    fi
}

# Check if server is running
is_server_running() {
    curl -s -o /dev/null -w "%{http_code}" http://localhost:$ZO_MOUNT_PORT/ 2>/dev/null | grep -q "200\|301\|302\|401"
}

# Check if we're running inside Zo Computer environment
check_zo_computer_environment() {
    # Check if we're in the workspace directory
    if [[ "$PWD" == /home/workspace* ]]; then
        return 0
    fi
    
    # Check for Zo Computer specific paths
    if [ -d "/home/workspace" ] || [ -d "/__substrate" ]; then
        return 0
    fi
    
    # Check hostname patterns
    if [[ "$(hostname)" == *"zo.computer"* ]]; then
        return 0
    fi
    
    # Not in Zo Computer environment
    return 1
}

# Start WebDAV server
start_server() {
    echo -e "${CYAN}Starting WebDAV server...${RESET}"
    
    # Detect Python command (Windows uses 'py', Unix uses 'python3')
    PYTHON_CMD=""
    if command -v python3 &> /dev/null; then
        PYTHON_CMD="python3"
    elif command -v py &> /dev/null; then
        PYTHON_CMD="py"
    else
        echo -e "${RED}Error: Python 3 is not installed${RESET}"
        echo "Install from: https://www.python.org/downloads/"
        exit 1
    fi
    
    # Check if dependencies are installed
    if ! $PYTHON_CMD -c "import wsgidav" 2>/dev/null; then
        echo -e "${YELLOW}Installing dependencies...${RESET}"
        $PYTHON_CMD -m pip install -r "$(dirname "$0")/requirements.txt" || {
            echo -e "${RED}Failed to install dependencies${RESET}"
            echo "Try manually: $PYTHON_CMD -m pip install wsgidav cheroot requests"
            exit 1
        }
    fi
    
    # Set temp paths (Windows-compatible)
    if [[ "$OSTYPE" == "msys" ]] || [[ "$OSTYPE" == "cygwin" ]]; then
        LOG_FILE="$TEMP/zoMount.log"
        PID_FILE="$TEMP/zoMount.pid"
    else
        LOG_FILE="/tmp/zoMount.log"
        PID_FILE="/tmp/zoMount.pid"
    fi
    
    # Start server in background
    echo -e "${YELLOW}Starting Python server...${RESET}"
    $PYTHON_CMD "$SERVER_SCRIPT" > "$LOG_FILE" 2>&1 &
    SERVER_PID=$!
    echo $SERVER_PID > "$PID_FILE"
    
    # Wait for server to be ready
    echo -e "${YELLOW}Waiting for server to start...${RESET}"
    for i in {1..15}; do
        if is_server_running; then
            echo -e "${GREEN}✓ Server is running (PID: $SERVER_PID)${RESET}"
            return 0
        fi
        sleep 1
    done
    
    echo -e "${RED}✗ Server failed to start${RESET}"
    echo "Check logs: cat \"$LOG_FILE\""
    exit 1
}

# Mount filesystem
mount_filesystem() {
    local os=$(detect_os)
    
    echo -e "${CYAN}Mounting workspace...${RESET}"
    
    # Create mount point if it doesn't exist
    mkdir -p "$ZO_MOUNT_POINT"
    
    case $os in
        macos)
            # macOS uses mount_webdav
            if mount | grep -q "$ZO_MOUNT_POINT"; then
                echo -e "${YELLOW}Already mounted at $ZO_MOUNT_POINT${RESET}"
                return 0
            fi
            
            mount_webdav -s http://localhost:$ZO_MOUNT_PORT "$ZO_MOUNT_POINT" 2>/dev/null || {
                echo -e "${RED}✗ Mount failed${RESET}"
                echo "Try manually: mount_webdav http://localhost:$ZO_MOUNT_PORT $ZO_MOUNT_POINT"
                exit 1
            }
            ;;
            
        linux)
            # Linux uses davfs2
            if ! command -v mount.davfs &> /dev/null; then
                echo -e "${YELLOW}Installing davfs2...${RESET}"
                sudo apt-get update && sudo apt-get install -y davfs2 || {
                    echo -e "${RED}Failed to install davfs2${RESET}"
                    echo "Install manually: sudo apt-get install davfs2"
                    exit 1
                }
            fi
            
            if mount | grep -q "$ZO_MOUNT_POINT"; then
                echo -e "${YELLOW}Already mounted at $ZO_MOUNT_POINT${RESET}"
                return 0
            fi
            
            # Configure davfs2 to skip authentication (our server doesn't use HTTP auth)
            DAVFS_CONF="/tmp/zoMount_davfs.conf"
            cat > "$DAVFS_CONF" << 'EOF'
# Temporary davfs2 config for zoMount
use_locks 0
ask_auth 0
secrets /tmp/zoMount_secrets
EOF
            
            # Create empty secrets file
            touch /tmp/zoMount_secrets
            chmod 600 /tmp/zoMount_secrets
            
            # Mount using davfs2 with custom config
            echo -e "${YELLOW}Mounting (you may need to enter sudo password)...${RESET}"
            
            # Set trap to cleanup on failure
            cleanup_on_fail() {
                echo -e "${RED}Mount failed, cleaning up...${RESET}"
                # Kill the server we just started
                if [ -f /tmp/zoMount.pid ]; then
                    PID=$(cat /tmp/zoMount.pid)
                    kill $PID 2>/dev/null || true
                    rm /tmp/zoMount.pid 2>/dev/null || true
                fi
            }
            
            if ! sudo mount -t davfs -o conf="$DAVFS_CONF",uid=$(id -u),gid=$(id -g) \
                http://localhost:$ZO_MOUNT_PORT "$ZO_MOUNT_POINT" 2>&1; then
                cleanup_on_fail
                echo -e "${RED}✗ Mount failed${RESET}"
                echo ""
                echo -e "${YELLOW}Troubleshooting:${RESET}"
                echo "1. Check server logs: tail /tmp/zoMount.log"
                echo "2. Make sure server is running: curl http://localhost:9999/"
                echo "3. Try restarting: ./mount_zo unmount && ./mount_zo mount"
                exit 1
            fi
            ;;
            
        windows)
            # Windows uses net use
            net use Z: http://localhost:$ZO_MOUNT_PORT 2>/dev/null || {
                echo -e "${RED}✗ Mount failed${RESET}"
                echo "Try manually: net use Z: http://localhost:$ZO_MOUNT_PORT"
                exit 1
            }
            ZO_MOUNT_POINT="Z:"
            ;;
            
        *)
            echo -e "${RED}Unsupported OS${RESET}"
            exit 1
            ;;
    esac
    
    echo -e "${GREEN}✓ Mounted at $ZO_MOUNT_POINT${RESET}"
}

# Unmount filesystem
unmount_filesystem() {
    local os=$(detect_os)
    
    echo -e "${CYAN}Unmounting workspace...${RESET}"
    
    case $os in
        macos)
            if mount | grep -q "$ZO_MOUNT_POINT"; then
                umount "$ZO_MOUNT_POINT" 2>/dev/null || {
                    echo -e "${RED}✗ Unmount failed${RESET}"
                    exit 1
                }
            fi
            ;;
            
        linux)
            if mount | grep -q "$ZO_MOUNT_POINT"; then
                sudo umount "$ZO_MOUNT_POINT" 2>/dev/null || {
                    echo -e "${RED}✗ Unmount failed${RESET}"
                    exit 1
                }
            fi
            ;;
            
        windows)
            net use Z: /delete 2>/dev/null || true
            ;;
    esac
    
    echo -e "${GREEN}✓ Unmounted${RESET}"
}

# Stop server
stop_server() {
    if [ -f /tmp/zoMount.pid ]; then
        PID=$(cat /tmp/zoMount.pid)
        if ps -p $PID > /dev/null 2>&1; then
            echo -e "${CYAN}Stopping server (PID: $PID)...${RESET}"
            kill $PID 2>/dev/null || true
            rm /tmp/zoMount.pid
            echo -e "${GREEN}✓ Server stopped${RESET}"
        fi
    fi
}

# Main command handler
case "${1:-mount}" in
    mount)
        # Check if we're running inside Zo Computer
        if check_zo_computer_environment; then
            clear
            echo -e "${RED}"
            cat << "ERROR"
     ██████╗ ██╗  ██╗    ███╗   ██╗ ██████╗ 
    ██╔═══██╗██║  ██║    ████╗  ██║██╔═══██╗
    ██║   ██║███████║    ██╔██╗ ██║██║   ██║
    ██║   ██║██╔══██║    ██║╚██╗██║██║   ██║
    ╚██████╔╝██║  ██║    ██║ ╚████║╚██████╔╝
     ╚═════╝ ╚═╝  ╚═╝    ╚═╝  ╚═══╝ ╚═════╝ 
ERROR
            echo -e "${RESET}"
            echo ""
            echo -e "${BOLD}${RED}Cannot Mount From Zo Computer VPS!${RESET}"
            echo ""
            echo -e "${YELLOW}This feature is designed for mounting your Zo Computer workspace"
            echo -e "onto your ${BOLD}local machine${RESET}${YELLOW} (Windows, macOS, Linux laptop/desktop).${RESET}"
            echo ""
            echo -e "You are currently ${RED}inside${RESET} your Zo Computer VPS environment."
            echo -e "Mounting the workspace onto itself doesn't make sense!"
            echo ""
            echo -e "${CYAN}To use this feature:${RESET}"
            echo -e "  1. Exit your SSH session (type 'exit')"
            echo -e "  2. Run zochat on your ${BOLD}local machine${RESET}"
            echo -e "  3. Select [8] Mount"
            echo ""
            exit 1
        fi
        
        if is_server_running; then
            echo -e "${GREEN}Server is already running${RESET}"
        else
            start_server
        fi
        mount_filesystem
        echo ""
        echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
        echo -e "${BOLD}  Zo Computer workspace mounted!${RESET}"
        echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
        echo ""
        echo -e "  ${CYAN}Mount point:${RESET} $ZO_MOUNT_POINT"
        echo -e "  ${CYAN}Status:${RESET}      $(mount | grep $ZO_MOUNT_POINT | head -1)"
        echo ""
        echo -e "${YELLOW}To unmount:${RESET} ./mount_zo unmount"
        echo ""
        ;;
        
    unmount)
        unmount_filesystem
        stop_server
        ;;
        
    status)
        if is_server_running; then
            echo -e "${GREEN}✓ Server is running on port $ZO_MOUNT_PORT${RESET}"
            if mount | grep -q "$ZO_MOUNT_POINT"; then
                echo -e "${GREEN}✓ Mounted at $ZO_MOUNT_POINT${RESET}"
            else
                echo -e "${YELLOW}⚠ Server running but not mounted${RESET}"
            fi
        else
            echo -e "${RED}✗ Server is not running${RESET}"
        fi
        ;;
        
    *)
        echo "Usage: $0 {mount|unmount|status}"
        exit 1
        ;;
esac
