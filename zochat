#!/bin/bash
export LESSCHARSET=utf-8
CONFIG_DIR="$HOME/.config/zo-chat"
CONFIG_FILE="$CONFIG_DIR/config"
STATS_FILE="$CONFIG_DIR/stats.json"
# Colors
CYAN='\033[36m'
GREEN='\033[32m'
YELLOW='\033[33m'
MAGENTA='\033[35m'
BLUE='\033[34m'
RED='\033[31m'
BOLD='\033[1m'
DIM='\033[2m'
RESET='\033[0m'
setup() {
    clear
    echo -e "${CYAN}"
    cat << "BANNER"
    ███████╗ ██████╗      ██████╗██╗  ██╗ █████╗ ████████╗
    ╚══███╔╝██╔═══██╗    ██╔════╝██║  ██║██╔══██╗╚══██╔══╝
      ███╔╝ ██║   ██║    ██║     ███████║███████║   ██║   
     ███╔╝  ██║   ██║    ██║     ██╔══██║██╔══██║   ██║   
    ███████╗╚██████╔╝    ╚██████╗██║  ██║██║  ██║   ██║   
    ╚══════╝ ╚═════╝      ╚═════╝╚═╝  ╚═╝╚═╝  ╚═╝   ╚═╝   
BANNER
    echo -e "${RESET}"
    echo -e "${BOLD}        Terminal AI Client - First Time Setup${RESET}"
    echo ""
    echo -e "${DIM}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
    echo ""
    echo "How to get your access token:"
    echo -e "  ${CYAN}1.${RESET} Open Zo Computer in browser"
    echo -e "  ${CYAN}2.${RESET} Press ${BOLD}F12${RESET} for DevTools"
    echo -e "  ${CYAN}3.${RESET} Application → Cookies → .zo.computer"
    echo -e "  ${CYAN}4.${RESET} Copy the ${BOLD}'access_token'${RESET} value"
    echo ""
    echo -e "${DIM}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
    echo ""
    echo -n "Paste your token: "
    read -r token
    echo -n "Your domain (e.g., daniel): "
    read -r domain
    
    mkdir -p "$CONFIG_DIR"
    echo "ACCESS_TOKEN=\"$token\"" > "$CONFIG_FILE"
    echo "DOMAIN=\"${domain}.zo.computer\"" >> "$CONFIG_FILE"
    chmod 600 "$CONFIG_FILE"
    
    # Initialize stats
    echo '{"total_messages":0,"total_tokens":0,"sessions":0}' > "$STATS_FILE"
    
    echo ""
    echo -e "${GREEN}✓${RESET} Setup complete! Config saved securely."
    sleep 2
}
[ ! -f "$CONFIG_FILE" ] && setup
source "$CONFIG_FILE"
# Load/create stats
[ ! -f "$STATS_FILE" ] && echo '{"total_messages":0,"total_tokens":0,"sessions":0}' > "$STATS_FILE"
API_BASE="https://api.zo.computer"
trap 'save_stats; echo ""; echo -e "${DIM}Session ended. Goodbye!${RESET}"; exit 0' INT TERM
# Update session count
if command -v jq >/dev/null 2>&1; then
    jq '.sessions += 1' "$STATS_FILE" > "$STATS_FILE.tmp" && mv "$STATS_FILE.tmp" "$STATS_FILE"
fi
save_stats() {
    if command -v jq >/dev/null 2>&1; then
        [ -n "$SESSION_MESSAGES" ] && jq ".total_messages += $SESSION_MESSAGES" "$STATS_FILE" > "$STATS_FILE.tmp" && mv "$STATS_FILE.tmp" "$STATS_FILE"
        [ -n "$SESSION_TOKENS" ] && jq ".total_tokens += $SESSION_TOKENS" "$STATS_FILE" > "$STATS_FILE.tmp" && mv "$STATS_FILE.tmp" "$STATS_FILE"
    fi
}
SESSION_MESSAGES=0
SESSION_TOKENS=0
# Self-update function
update_script() {
    echo ""
    echo -e "${YELLOW}Checking for updates...${RESET}"
    echo ""
    
    # Check if running from git repo
    if [ -d ".git" ] || git rev-parse --git-dir > /dev/null 2>&1; then
        echo -e "${DIM}Git repository detected. Pulling changes...${RESET}"
        if git pull -q origin main; then
            echo ""
            echo -e "${GREEN}✓ Updated successfully!${RESET}"
            echo -e "${DIM}Restarting application...${RESET}"
            sleep 1
            exec "$0"
        else
            echo ""
            echo -e "${RED}✗ Update failed.${RESET}"
            echo -e "Try running 'git pull' manually."
        fi
    else
        # Direct download update
        echo -e "${DIM}Downloading latest version...${RESET}"
        if curl -s -o "$0.tmp" "https://raw.githubusercontent.com/wishingforu/zochat/main/zochat"; then
            chmod +x "$0.tmp"
            mv "$0.tmp" "$0"
            echo ""
            echo -e "${GREEN}✓ Updated successfully!${RESET}"
            echo -e "${DIM}Restarting application...${RESET}"
            sleep 1
            exec "$0"
        else
            echo ""
            echo -e "${RED}✗ Download failed.${RESET}"
            rm -f "$0.tmp"
        fi
    fi
    echo ""
    read -n 1 -s -r -p "Press any key to continue..."
}

# Startup splash screen
clear
echo ""
echo -e "${BOLD}${CYAN}                    The Ultimate CLI for Zo Computer${RESET}"
echo ""
sleep 0.5

while true; do
    clear
    echo -e "${CYAN}"
    cat << "BANNER"
   ███████╗ ██████╗      ██████╗██╗  ██╗ █████╗ ████████╗
   ╚══███╔╝██╔═══██╗    ██╔════╝██║  ██║██╔══██╗╚══██╔══╝
     ███╔╝ ██║   ██║    ██║     ███████║███████║   ██║   
    ███╔╝  ██║   ██║    ██║     ██╔══██║██╔══██║   ██║   
   ███████╗╚██████╔╝    ╚██████╗██║  ██║██║  ██║   ██║   
   ╚══════╝ ╚═════╝      ╚═════╝╚═╝  ╚═╝╚═╝  ╚═╝   ╚═╝   
BANNER
    echo -e "${RESET}"
    echo ""
    echo -e "${BOLD}${CYAN}       The Ultimate CLI Tool for Zo Computer${RESET}"
    echo ""
    echo -e "${DIM}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
    echo -e "  ${DIM}Connected as: ${BOLD}${GREEN}${DOMAIN}${RESET}"
    echo -e "${DIM}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
    echo ""
    echo -e "  ${CYAN}[1]${RESET} ${BOLD}AI Models${RESET}         - Start a conversation"
    echo -e "  ${CYAN}[2]${RESET} ${BOLD}Events${RESET}            - View and schedule tasks"
    echo -e "  ${CYAN}[3]${RESET} ${BOLD}Services${RESET}          - Manage services"
    echo -e "  ${CYAN}[4]${RESET} ${BOLD}Billing${RESET}           - Credits and usage"
    echo -e "  ${CYAN}[5]${RESET} ${BOLD}System${RESET}            - View machine stats"
    echo -e "  ${CYAN}[6]${RESET} ${BOLD}Exit${RESET}              - Close application"
    echo ""
    echo -e "${DIM}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
    echo ""
    echo -n "Choice: "
    read main_choice
    # Strip whitespace/newlines
    main_choice=$(echo "$main_choice" | tr -d '[:space:]')

    case $main_choice in
        1)
            # Continue to AI model selection
            break
            ;;
        2)
            # Events Management
            while true; do
                clear
                echo -e "${MAGENTA}"
                cat << "BANNER"
    ███████╗ ██████╗      ██████╗██╗  ██╗ █████╗ ████████╗
    ╚══███╔╝██╔═══██╗    ██╔════╝██║  ██║██╔══██╗╚══██╔══╝
      ███╔╝ ██║   ██║    ██║     ███████║███████║   ██║   
     ███╔╝  ██║   ██║    ██║     ██╔══██║██╔══██║   ██║   
    ███████╗╚██████╔╝    ╚██████╗██║  ██║██║  ██║   ██║   
    ╚══════╝ ╚═════╝      ╚═════╝╚═╝  ╚═╝╚═╝  ╚═╝   ╚═╝   
        /horse)
            clear
            echo -e "${CYAN}"
            cat << 'HORSE'
                                                                         
                                     <k@$$$$$$$$$$$$$$$$_               
                   )/ckWBB@x.      ($$$$$$$$$$$$$$$$$$$@.               
                  b$$$@BBM_\@%    ~B$$$$$$$$$$$$$$$$$$$h                
                  b<[@$$$$$@L(B\. \$$$$$$$$$$$$$$$$$$@W                 
                  bvC@@$$$$$$B`Bb t$$$$$$$$$$$$$$$$$8'.                 
                  b@#. :@$$$$$@ @Ou$$$$$$@$@$$@@ot                      
                  w^m,  f@$@."\'`zm$$@.                                 
                   ..   /@$$$$$$@^@$$#                                  
                 .h$@C .@$$$$$B^h@@@@i                                  
                 lBu@W.>\B$$$$@bbkhBB                                   
                .@Y  lB@@"B$$$@@$$$$@@                                  
                &&. .@+.@$^$$@"B$$$$@XwqZ(.                             
               .8O, hQ  IBBBBn#@$$$$$$$$$$$B@B@BBi                      
                   nd        b@@@$@@@@$$$$$$$@'@$@{                     
                   [@q'         .O8'8@$$$$$$$@ $$$&                     
                     ..       "@%"@$$$$$$$$$^ $$$&                     
                             M$$@X@$$$$$@h(    $$$&                     
                             B$$$O_B$$$B       $$$&                     
                              f@@h. ?@@*       @$$&                     
                                d@j   ?B@W     YB$&                     
                              -B@"    *BJ       "@B}                    
                           .]@8    .&@C                                 
                          _Bw^    MBJ                                   
                         tttl   a@@B'                                   
                                                                         
HORSE
            echo -e "${RESET}"
            echo -e "${DIM}            The legendary Zo Computer steed${RESET}"
            echo ""
            read -n 1 -s -r -p "Press any key to continue..."
            ;;
        *)
            echo "Invalid choice"
            sleep 1
            ;;
    esac
done

# Model Selection
clear
echo -e "${CYAN}"
cat << "BANNER"
   ███████╗ ██████╗      ██████╗██╗  ██╗ █████╗ ████████╗
   ╚══███╔╝██╔═══██╗    ██╔════╝██║  ██║██╔══██╗╚══██╔══╝
     ███╔╝ ██║   ██║    ██║     ███████║███████║   ██║   
    ███╔╝  ██║   ██║    ██║     ██╔══██║██╔══██║   ██║   
   ███████╗╚██████╔╝    ╚██████╗██║  ██║██║  ██║   ██║   
   ╚══════╝ ╚═════╝      ╚═════╝╚═╝  ╚═╝╚═╝  ╚═╝   ╚═╝   
BANNER
echo -e "${RESET}"
echo ""
echo -e "${BOLD}${CYAN}                    Select Your AI Model${RESET}"
echo ""
echo -e "${DIM}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
echo ""
echo -e "  ${CYAN}[1]${RESET} ${BOLD}GPT-5.1${RESET}        - OpenAI's latest flagship"
echo -e "  ${CYAN}[2]${RESET} ${BOLD}GPT-5 Mini${RESET}     - Fast and efficient"
echo -e "  ${CYAN}[3]${RESET} ${BOLD}Claude Haiku${RESET}   - Anthropic's smart assistant"
echo -e "  ${CYAN}[4]${RESET} ${BOLD}Grok 4${RESET}         - xAI's reasoning powerhouse"
echo -e "  ${CYAN}[5]${RESET} ${BOLD}Gemini 3 Pro${RESET}   - Google's advanced model"
echo -e "  ${CYAN}[6]${RESET} ${BOLD}GLM-4.6${RESET}        - Z-AI's exacto model"
echo -e "  ${CYAN}[7]${RESET} ${BOLD}Kimi K2${RESET}        - Moonshot's thinking model"
echo -e "  ${CYAN}[8]${RESET} ${BOLD}GPT-5.1 Codex${RESET} - OpenAI's code specialist"
echo -e "  ${CYAN}[9]${RESET} ${BOLD}Claude Opus 4.5${RESET} - Anthropic's most capable"
echo -e "  ${CYAN}[10]${RESET} ${BOLD}Claude Sonnet 4.5${RESET} - Balanced performance"
echo -e "  ${CYAN}[11]${RESET} ${BOLD}Claude Sonnet 4${RESET} - Reliable assistant"
echo -e "  ${CYAN}[12]${RESET} ${BOLD}Back${RESET}            - Return to main menu"
echo ""
echo -e "${DIM}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
echo ""
echo -n "Choice: "
read choice
case $choice in
    1) 
        model="openai:gpt-5.1-2025-11-13"; name="GPT-5.1"; color=$GREEN
        # GPT-5.1 Reasoning Level Selection
        clear
        echo -e "${GREEN}"
        cat << "BANNER"
   ██████╗██╗  ██╗ █████╗ ████████╗
  ██╔════╝██║  ██║██╔══██╗╚══██╔══╝
  ██║     ███████║███████║   ██║   
  ██║     ██╔══██║██╔══██║   ██║   
  ╚██████╗██║  ██║██║  ██║   ██║   
   ╚═════╝╚═╝  ╚═╝╚═╝  ╚═╝   ╚═╝   
BANNER
        echo -e "${RESET}"
        echo ""
        echo -e "${BOLD}           Select Reasoning Depth${RESET}"
        echo ""
        echo -e "${DIM}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
        echo ""
        echo -e "  ${GREEN}[0]${RESET} ${BOLD}Quick Mode${RESET}      - Fast responses, minimal reasoning"
        echo -e "  ${GREEN}[1]${RESET} ${BOLD}Balanced Mode${RESET}   - Moderate reasoning depth"
        echo -e "  ${GREEN}[2]${RESET} ${BOLD}Deep Thinking${RESET}   - Maximum reasoning power"
        echo ""
        echo -e "${DIM}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
        echo ""
        echo -e "${DIM}Type '/exit' anytime to return to main menu${RESET}"
        echo ""
        echo -n "Reasoning Level: "
        read reasoning_choice
        
        # Check for /exit
        if [ "$reasoning_choice" = "/exit" ]; then
            exec "$0"
        fi
        
        case $reasoning_choice in
            0) reasoning_level=0; reasoning_name="Quick" ;;
            1) reasoning_level=1; reasoning_name="Balanced" ;;
            2) reasoning_level=2; reasoning_name="Deep" ;;
            *) reasoning_level=1; reasoning_name="Balanced" ;;
        esac
        
        echo ""
        echo -e "${BOLD}           Select Verbosity Level${RESET}"
        echo ""
        echo -e "${DIM}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
        echo ""
        echo -e "  ${GREEN}[1]${RESET} ${BOLD}Low${RESET}      - Concise responses"
        echo -e "  ${GREEN}[2]${RESET} ${BOLD}Medium${RESET}   - Standard detail"
        echo -e "  ${GREEN}[3]${RESET} ${BOLD}High${RESET}     - Detailed explanations"
        echo ""
        echo -e "${DIM}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
        echo ""
        echo -e "${DIM}Type '/exit' anytime to return to main menu${RESET}"
        echo ""
        echo -n "Verbosity: "
        read verbosity_choice
        
        # Check for /exit
        if [ "$verbosity_choice" = "/exit" ]; then
            exec "$0"
        fi
        
        case $verbosity_choice in
            1) verbosity_level="low" ;;
            2) verbosity_level="medium" ;;
            3) verbosity_level="high" ;;
            *) verbosity_level="low" ;;
        esac
        
        model_settings="{\"reasoning\":{\"kind\":\"level\",\"level\":$reasoning_level},\"verbosity\":\"$verbosity_level\"}"
        name="GPT-5.1 ($reasoning_name)"
        ;;
    2) 
        model="openai:gpt-5-mini-2025-08-07"; name="GPT-5 Mini"; color=$BLUE
        model_settings="{}"
        ;;
    4) 
        model="anthropic:claude-haiku-4-5-20251001"; name="Claude Haiku"; color=$MAGENTA
        # Claude Haiku Token Budget Selection
        clear
        echo -e "${MAGENTA}"
        cat << "BANNER"
    ╔═══════════════════════════════════════════════════════════╗
    ║                                                           ║
    ║              CLAUDE HAIKU TOKEN BUDGET                    ║
    ║                                                           ║
    ╚═══════════════════════════════════════════════════════════╝
BANNER
        echo -e "${RESET}"
        echo ""
        echo -e "${BOLD}           Select Token Budget${RESET}"
        echo ""
        echo -e "${DIM}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
        echo ""
        echo -e "  ${MAGENTA}[1]${RESET} ${BOLD}15,000 Tokens${RESET}   - Faster, lighter responses"
        echo -e "  ${MAGENTA}[2]${RESET} ${BOLD}30,000 Tokens${RESET}   - Extended thinking capacity"
        echo ""
        echo -e "${DIM}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
        echo ""
        echo -e "${DIM}Type '/exit' anytime to return to main menu${RESET}"
        echo ""
        echo -n "Token Budget: "
        read budget_choice
        
        # Check for /exit
        if [ "$budget_choice" = "/exit" ]; then
            exec "$0"
        fi
        
        case $budget_choice in
            1) token_budget=15000; budget_name="15k" ;;
            2) token_budget=30000; budget_name="30k" ;;
            *) token_budget=15000; budget_name="15k" ;;
        esac
        
        model_settings="{\"reasoning\":{\"kind\":\"budget_tokens\",\"tokens\":$token_budget},\"verbosity\":null}"
        name="Claude Haiku ($budget_name)"
        ;;
    8) 
        model="grok-4-1-fast-reasoning"; name="Grok 4"; color=$CYAN
        model_settings="{}"
        ;;
    9) 
        model="google-vertex:gemini-3-pro-preview"; name="Gemini 3 Pro"; color=$YELLOW
        model_settings="{}"
        ;;
    10) 
        model="openrouter:z-ai/glm-4.6:exacto:floor"; name="GLM-4.6"; color=$CYAN
        model_settings="{}"
        ;;
    11) 
        model="openrouter:moonshotai/kimi-k2-thinking:floor"; name="Kimi K2"; color=$MAGENTA
        model_settings="{}"
        ;;
    3) 
        model="openai:gpt-5.1-codex-mini"; name="GPT-5.1 Codex"; color=$GREEN
        model_settings="{}"
        ;;
    5) 
        model="anthropic:claude-opus-4-5-20251101"; name="Claude Opus 4.5"; color=$MAGENTA
        model_settings="{}"
        ;;
    6) 
        model="anthropic:claude-sonnet-4-5-20250929"; name="Claude Sonnet 4.5"; color=$MAGENTA
        # Claude Sonnet 4.5 Token Budget Selection
        clear
        echo -e "${MAGENTA}"
        cat << "BANNER"
    ╔═══════════════════════════════════════════════════════════╗
    ║                                                           ║
    ║          CLAUDE SONNET 4.5 TOKEN BUDGET                   ║
    ║                                                           ║
    ╚═══════════════════════════════════════════════════════════╝
BANNER
        echo -e "${RESET}"
        echo ""
        echo -e "${BOLD}           Select Token Budget${RESET}"
        echo ""
        echo -e "${DIM}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
        echo ""
        echo -e "  ${MAGENTA}[0]${RESET} ${BOLD}No Budget${RESET}       - Standard mode (0 tokens)"
        echo -e "  ${MAGENTA}[1]${RESET} ${BOLD}15,000 Tokens${RESET}   - Faster, lighter responses"
        echo -e "  ${MAGENTA}[2]${RESET} ${BOLD}30,000 Tokens${RESET}   - Extended thinking capacity"
        echo ""
        echo -e "${DIM}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
        echo ""
        echo -e "${DIM}Type '/exit' anytime to return to main menu${RESET}"
        echo ""
        echo -n "Token Budget: "
        read budget_choice
        
        # Check for /exit
        if [ "$budget_choice" = "/exit" ]; then
            exec "$0"
        fi
        
        case $budget_choice in
            0) token_budget=0; budget_name="Standard" ;;
            1) token_budget=15000; budget_name="15k" ;;
            2) token_budget=30000; budget_name="30k" ;;
            *) token_budget=0; budget_name="Standard" ;;
        esac
        
        model_settings="{\"reasoning\":{\"kind\":\"budget_tokens\",\"tokens\":$token_budget}}"
        name="Claude Sonnet 4.5 ($budget_name)"
        ;;
    7) 
        model="anthropic:claude-sonnet-4-20250514"; name="Claude Sonnet 4"; color=$MAGENTA
        # Claude Sonnet 4 Token Budget Selection
        clear
        echo -e "${MAGENTA}"
        cat << "BANNER"
    ╔═══════════════════════════════════════════════════════════╗
    ║                                                           ║
    ║            CLAUDE SONNET 4 TOKEN BUDGET                   ║
    ║                                                           ║
    ╚═══════════════════════════════════════════════════════════╝
BANNER
        echo -e "${RESET}"
        echo ""
        echo -e "${BOLD}           Select Token Budget${RESET}"
        echo ""
        echo -e "${DIM}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
        echo ""
        echo -e "  ${MAGENTA}[0]${RESET} ${BOLD}No Budget${RESET}       - Standard mode (0 tokens)"
        echo -e "  ${MAGENTA}[1]${RESET} ${BOLD}15,000 Tokens${RESET}   - Faster, lighter responses"
        echo -e "  ${MAGENTA}[2]${RESET} ${BOLD}30,000 Tokens${RESET}   - Extended thinking capacity"
        echo ""
        echo -e "${DIM}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
        echo ""
        echo -e "${DIM}Type '/exit' anytime to return to main menu${RESET}"
        echo ""
        echo -n "Token Budget: "
        read budget_choice
        
        # Check for /exit
        if [ "$budget_choice" = "/exit" ]; then
            exec "$0"
        fi
        
        case $budget_choice in
            0) token_budget=0; budget_name="Standard" ;;
            1) token_budget=15000; budget_name="15k" ;;
            2) token_budget=30000; budget_name="30k" ;;
            *) token_budget=0; budget_name="Standard" ;;
        esac
        
        model_settings="{\"reasoning\":{\"kind\":\"budget_tokens\",\"tokens\":$token_budget}}"
        name="Claude Sonnet 4 ($budget_name)"
        ;;
    12)
        exec "$0"
        ;;
    *) echo "Invalid choice"; exit 1 ;;
esac
clear

# Check if model is Claude
if echo "$model" | grep -q "claude"; then
    # Orange color for Claude
    ORANGE='\033[38;5;208m'
    echo -e "${ORANGE}"
    cat << "BANNER"
    ┌─────────────────────────────────────────────────────┐
    │                                                     │
    │   ░█████╗░██╗░░░░░░█████╗░██╗░░░██╗██████╗░███████╗│
    │   ██╔══██╗██║░░░░░██╔══██╗██║░░░██║██╔══██╗██╔════╝│
    │   ██║░░╚═╝██║░░░░░███████║██║░░░██║██║░░██║█████╗  │
    │   ██║░░██╗██║░░░░░██╔══██║██║░░░██║██║░░██║██╔══╝  │
    │   ╚█████╔╝███████╗██║░░██║╚██████╔╝██████╔╝███████╗│
    │   ░╚════╝░╚══════╝╚═╝░░╚═╝░╚═════╝░╚═════╝░╚══════╝│
    │                                                     │
    └─────────────────────────────────────────────────────┘
BANNER
else
    echo -e "${color}"
    cat << "BANNER"
    ┌─────────────────────────────────────────────────────┐
    │                                                     │
    │   ░█████╗░██╗░░██╗░█████╗░████████╗                │
    │   ██╔══██╗██║░░██║██╔══██╗╚══██╔══╝                │
    │   ██║░░╚═╝███████║███████║░░░██║░░░                │
    │   ██║░░██╗██╔══██║██╔══██║░░░██║░░░                │
    │   ╚█████╔╝██║░░██║██║░░██║░░░██║░░░                │
    │   ░╚════╝░╚═╝░░╚═╝╚═╝░░╚═╝░░░╚═╝░░░                │
    │                                                     │
    └─────────────────────────────────────────────────────┘
BANNER
fi
echo -e "${RESET}"
echo ""
echo -e "${BOLD}  Active Model: ${color}${name}${RESET}"
echo ""
if command -v jq > /dev/null 2>&1; then
    stats=$(cat "$STATS_FILE")
    total_msg=$(echo "$stats" | jq -r '.total_messages')
    total_tok=$(echo "$stats" | jq -r '.total_tokens')
    sessions=$(echo "$stats" | jq -r '.sessions')
    
    # Fetch credit balance
    balance=$(curl -s -X GET "$API_BASE/billing/credit-balance" \
        -H "cookie: access_token=$ACCESS_TOKEN" \
        -H "origin: https://$DOMAIN" 2>/dev/null)
    credits_cents=$(echo "$balance" | jq -r '.available_balance_cents' 2>/dev/null)
    credits_dollars=$(awk "BEGIN {printf \"%.2f\", $credits_cents / 100}" 2>/dev/null)
    
    echo -e "${DIM}  Stats: $total_msg messages • $total_tok tokens • Session #$sessions${RESET}"
    [ -n "$credits_dollars" ] && echo -e "${DIM}  Credits: ${GREEN}\$$credits_dollars${RESET}"
else
    echo -e "${DIM}  Stats: (jq not installed)${RESET}"
fi
echo ""
echo -e "${DIM}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
echo ""
echo -e "  ${CYAN}/exit${RESET}     - Exit chat"
echo -e "  ${CYAN}/stats${RESET}    - View detailed statistics"
echo -e "  ${CYAN}/reset${RESET}    - Reconfigure token"
echo ""
echo -e "${DIM}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
echo ""
while true; do
    echo -ne "${BOLD}You${RESET} ▶ "
    read -r msg
    
    case "$msg" in
        /exit) 
            save_stats
            echo ""
            echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
            echo -e "  ${BOLD}Session Summary${RESET}"
            echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
            echo -e "  Messages: ${GREEN}$SESSION_MESSAGES${RESET}"
            echo -e "  Tokens:   ${GREEN}$SESSION_TOKENS${RESET}"
            echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
            echo ""
            exec "$0"
            ;;
        /stats)
            echo ""
            echo -e "${MAGENTA}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
            echo -e "  ${BOLD}All-Time Statistics${RESET}"
            echo -e "${MAGENTA}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
            echo -e "  Total Messages: ${GREEN}$total_msg${RESET}"
            echo -e "  Total Tokens:   ${GREEN}$total_tok${RESET}"
            echo -e "  Total Sessions: ${GREEN}$sessions${RESET}"
            echo -e "${MAGENTA}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
            echo ""
            continue
            ;;
        /reset) rm -f "$CONFIG_FILE"; exec "$0" ;;
        /horse)
            echo ""
            echo -e "${CYAN}"
            cat << 'HORSE'
                                                                         
                                     <k@$$$$$$$$$$$$$$$$_               
                   )/ckWBB@x.      ($$$$$$$$$$$$$$$$$$$@.               
                  b$$$@BBM_\@%    ~B$$$$$$$$$$$$$$$$$$$h                
                  b<[@$$$$$@L(B\. \$$$$$$$$$$$$$$$$$$@W                 
                  bvC@@$$$$$$B`Bb t$$$$$$$$$$$$$$$$$8'.                 
                  b@#. :@$$$$$@ @Ou$$$$$$@$@$$@@ot                      
                  w^m,  f@$@."\'`zm$$@.                                 
                   ..   /@$$$$$$@^@$$#                                  
                 .h$@C .@$$$$$B^h@@@@i                                  
                 lBu@W.>\B$$$$@bbkhBB                                   
                .@Y  lB@@"B$$$@@$$$$@@                                  
                &&. .@+.@$^$$@"B$$$$@XwqZ(.                             
               .8O, hQ  IBBBBn#@$$$$$$$$$$$B@B@BBi                      
                   nd        b@@@$@@@@$$$$$$$@'@$@{                     
                   [@q'         .O8'8@$$$$$$$@ $$$&                     
                     ..       "@%"@$$$$$$$$$^ $$$&                     
                             M$$@X@$$$$$@h(    $$$&                     
                             B$$$O_B$$$B       $$$&                     
                              f@@h. ?@@*       @$$&                     
                                d@j   ?B@W     YB$&                     
                              -B@"    *BJ       "@B}                    
                           .]@8    .&@C                                 
                          _Bw^    MBJ                                   
                         tttl   a@@B'                                   
                                                                         
HORSE
            echo -e "${RESET}"
            echo -e "${DIM}            The legendary Zo Computer steed${RESET}"
            echo ""
            continue
            ;;
        "") continue ;;
    esac
    
    # Paste protection
    msg_length=${#msg}
    if [ $msg_length -gt 200 ]; then
        echo ""
        echo -e "${YELLOW}⚠ Large paste detected!${RESET} ${DIM}($msg_length chars)${RESET}"
        echo ""
        echo -e "${DIM}Preview:${RESET}"
        echo "${msg:0:150}..."
        echo ""
        echo -n "Send this? (y/n): "
        read confirm
        
        if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
            echo -e "${RED}✗${RESET} Cancelled"
            echo ""
            continue
        fi
    fi
    
    msg_esc=$(echo "$msg" | sed 's/"/\\"/g' | sed 's/\\/\\\\/g')
    
    echo ""
    
    # API request in background
    curl -s -X POST "$API_BASE/ask" \
        -H "content-type: application/json" \
        -H "cookie: access_token=$ACCESS_TOKEN" \
        -H "origin: https://$DOMAIN" \
        -d "{\"q\":\"$msg_esc\",\"model_name\":\"$model\",\"model_settings\":$model_settings,\"context_paths\":[],\"command_paths\":[]}" \
        > /tmp/zo_resp_$$ 2>/dev/null &
    
    CURL_PID=$!
    
    # EPIC loading animation
    frames=('⠋' '⠙' '⠹' '⠸' '⠼' '⠴' '⠦' '⠧' '⠇' '⠏')
    dots=('   ' '.  ' '.. ' '...')
    i=0
    
    while kill -0 $CURL_PID 2>/dev/null; do
        dot_idx=$((i / 3 % 4))
        printf "\r  ${color}${frames[$i]}${RESET} ${BOLD}Thinking${RESET}${dots[$dot_idx]}"
        i=$(( (i + 1) % 10 ))
        sleep 0.08
    done
    
    wait $CURL_PID
    printf "\r                                                    \r"
    
    resp=$(cat /tmp/zo_resp_$$)
    rm -f /tmp/zo_resp_$$
    
    ai=$(echo "$resp" | grep -A 1 "^event: End$" | tail -1 | sed 's/^data: //' | jq -r '.data.output' 2>/dev/null)
    
    tok_line=$(echo "$resp" | grep -A 1 "^event: FrontendModelResponse$" | tail -1 | sed 's/^data: //')
    tok_in=$(echo "$tok_line" | jq -r '.input_tokens // empty' 2>/dev/null)
    tok_out=$(echo "$tok_line" | jq -r '.output_tokens // empty' 2>/dev/null)
    
    SESSION_MESSAGES=$((SESSION_MESSAGES + 1))
    
    echo -e "${color}${BOLD}AI${RESET}  ▶ $ai"
    echo ""
    
    if [ -n "$tok_in" ] && [ "$tok_in" != "null" ] && [ "$tok_in" != "empty" ]; then
        tok_total=$((tok_in + tok_out))
        SESSION_TOKENS=$((SESSION_TOKENS + tok_total))
        
        # Create progress bar
        bar_width=30
        bar_filled=$((tok_out * bar_width / (tok_in + tok_out)))
        bar=""
        for ((j=0; j<bar_width; j++)); do
            if [ $j -lt $bar_filled ]; then
                bar+="█"
            else
                bar+="░"
            fi
        done
        
        echo -e "${DIM}      ┌─────────────────────────────────────────────────┐${RESET}"
        echo -e "${DIM}      │${RESET} ${GREEN}$bar${RESET} ${DIM}│${RESET}"
        echo -e "${DIM}      │  In: ${CYAN}$tok_in${RESET} ${DIM}│ Out: ${MAGENTA}$tok_out${RESET} ${DIM}│ Total: ${YELLOW}$tok_total${RESET}     ${DIM}│${RESET}"
        echo -e "${DIM}      └─────────────────────────────────────────────────┘${RESET}"
        echo ""
    fi
    
    echo -e "${DIM}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
    echo ""
done
