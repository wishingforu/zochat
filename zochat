#!/bin/bash
export LESSCHARSET=utf-8
CONFIG_DIR="$HOME/.config/zo-chat"
CONFIG_FILE="$CONFIG_DIR/config"
STATS_FILE="$CONFIG_DIR/stats.json"

# Detect Windows
IS_WINDOWS=false
if [[ "$OSTYPE" == "msys" ]] || [[ "$OSTYPE" == "cygwin" ]]; then
    IS_WINDOWS=true
fi

# Colors
CYAN='\033[36m'
GREEN='\033[32m'
YELLOW='\033[33m'
MAGENTA='\033[35m'
BLUE='\033[34m'
RED='\033[31m'
BOLD='\033[1m'
DIM='\033[2m'
RESET='\033[0m'

# Auto-install dependencies on Windows
auto_install_deps() {
    if [ "$IS_WINDOWS" = true ]; then
        # Check for jq
        if ! command -v jq &> /dev/null; then
            echo -e "${YELLOW}Installing jq for Windows...${RESET}"
            
            # Download jq for Windows
            JQ_DIR="$HOME/.local/bin"
            mkdir -p "$JQ_DIR"
            
            if command -v curl &> /dev/null; then
                curl -sL "https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-windows-amd64.exe" -o "$JQ_DIR/jq.exe"
                export PATH="$JQ_DIR:$PATH"
                echo -e "${GREEN}âœ“ jq installed${RESET}"
            else
                echo -e "${RED}Warning: curl not found, jq auto-install failed${RESET}"
                echo -e "${YELLOW}Please install jq manually or ignore if not using advanced features${RESET}"
            fi
        fi
        
        # Check for Python (for mount feature)
        if ! command -v py &> /dev/null && ! command -v python3 &> /dev/null; then
            echo -e "${YELLOW}Note: Python not found. Mount feature will be disabled.${RESET}"
            echo -e "${DIM}Install from: https://www.python.org/downloads/${RESET}"
        fi
    fi
}

# Run dependency check on first load
auto_install_deps
setup() {
    clear
    echo -e "${CYAN}"
    cat << "BANNER"
    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
    â•šâ•â•â–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ•â•â–ˆâ–ˆâ•”â•â•â•
      â–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   
     â–ˆâ–ˆâ–ˆâ•”â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   
    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•    â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   
    â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â•      â•šâ•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•   â•šâ•â•   
BANNER
    echo -e "${RESET}"
    echo -e "${BOLD}        Terminal AI Client - First Time Setup${RESET}"
    echo ""
    echo -e "${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
    echo ""
    echo "How to get your access token:"
    echo ""
    echo -e "${BOLD}Method 1 (Browser):${RESET}"
    echo -e "  ${CYAN}1.${RESET} Open Zo Computer in browser"
    echo -e "  ${CYAN}2.${RESET} Press ${BOLD}F12${RESET} for DevTools"
    echo -e "  ${CYAN}3.${RESET} Application â†’ Cookies â†’ .zo.computer"
    echo -e "  ${CYAN}4.${RESET} Copy the ${BOLD}'access_token'${RESET} value"
    echo ""
    echo -e "${BOLD}Method 2 (Settings):${RESET}"
    echo -e "  ${CYAN}1.${RESET} Go to Zo Computer â†’ Settings â†’ Developer"
    echo -e "  ${CYAN}2.${RESET} Edit ${BOLD}ZO_CLIENT_IDENTITY_TOKEN${RESET}"
    echo -e "  ${CYAN}3.${RESET} Copy the token value"
    echo ""
    echo -e "${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
    echo ""
    echo -n "Paste your token: "
    read -r token
    echo -n "Your domain (e.g., daniel): "
    read -r domain
    
    mkdir -p "$CONFIG_DIR"
    echo "ACCESS_TOKEN=\"$token\"" > "$CONFIG_FILE"
    echo "DOMAIN=\"${domain}.zo.computer\"" >> "$CONFIG_FILE"
    chmod 600 "$CONFIG_FILE"
    
    # Initialize stats
    echo '{"total_messages":0,"total_tokens":0,"sessions":0}' > "$STATS_FILE"
    
    echo ""
    echo -e "${GREEN}âœ“${RESET} Setup complete! Config saved securely."
    sleep 2
}
[ ! -f "$CONFIG_FILE" ] && setup
source "$CONFIG_FILE"
# Load/create stats
[ ! -f "$STATS_FILE" ] && echo '{"total_messages":0,"total_tokens":0,"sessions":0}' > "$STATS_FILE"
API_BASE="https://api.zo.computer"
trap 'save_stats; echo ""; echo -e "${DIM}Session ended. Goodbye!${RESET}"; exit 0' INT TERM
# Update session count
if command -v jq >/dev/null 2>&1; then
    jq '.sessions += 1' "$STATS_FILE" > "$STATS_FILE.tmp" && mv "$STATS_FILE.tmp" "$STATS_FILE"
fi
save_stats() {
    if command -v jq >/dev/null 2>&1; then
        [ -n "$SESSION_MESSAGES" ] && jq ".total_messages += $SESSION_MESSAGES" "$STATS_FILE" > "$STATS_FILE.tmp" && mv "$STATS_FILE.tmp" "$STATS_FILE"
        [ -n "$SESSION_TOKENS" ] && jq ".total_tokens += $SESSION_TOKENS" "$STATS_FILE" > "$STATS_FILE.tmp" && mv "$STATS_FILE.tmp" "$STATS_FILE"
    fi
}
SESSION_MESSAGES=0
SESSION_TOKENS=0
# Self-update function
update_script() {
    echo ""
    echo -e "${YELLOW}Checking for updates...${RESET}"
    echo ""
    
    # Check if running from git repo
    if [ -d ".git" ] || git rev-parse --git-dir > /dev/null 2>&1; then
        echo -e "${DIM}Git repository detected. Pulling changes...${RESET}"
        if git pull -q origin main; then
            echo ""
            echo -e "${GREEN}âœ“ Updated successfully!${RESET}"
            echo -e "${DIM}Restarting application...${RESET}"
            sleep 1
            exec "$0"
        else
            echo ""
            echo -e "${RED}âœ— Update failed.${RESET}"
            echo -e "Try running 'git pull' manually."
        fi
    else
        # Direct download update
        echo -e "${DIM}Downloading latest version...${RESET}"
        if curl -s -o "$0.tmp" "https://raw.githubusercontent.com/wishingforu/zochat/main/zochat"; then
            chmod +x "$0.tmp"
            mv "$0.tmp" "$0"
            echo ""
            echo -e "${GREEN}âœ“ Updated successfully!${RESET}"
            echo -e "${DIM}Restarting application...${RESET}"
            sleep 1
            exec "$0"
        else
            echo ""
            echo -e "${RED}âœ— Download failed.${RESET}"
            rm -f "$0.tmp"
        fi
    fi
    echo ""
    read -n 1 -s -r -p "Press any key to continue..."
}

# Startup splash screen
clear
echo ""
echo -e "${BOLD}${CYAN}                    The Ultimate CLI for Zo Computer${RESET}"
echo ""
sleep 0.5

while true; do
    clear
    echo -e "${CYAN}"
    cat << "BANNER"
   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
   â•šâ•â•â–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ•â•â–ˆâ–ˆâ•”â•â•â•
     â–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   
    â–ˆâ–ˆâ–ˆâ•”â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   
   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•    â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   
   â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â•      â•šâ•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•   â•šâ•â•   
BANNER
    echo -e "${RESET}"
    echo ""
    echo -e "${BOLD}${CYAN}       The Ultimate CLI Tool for Zo Computer${RESET}"
    echo ""
    echo -e "${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
    echo -e "  ${DIM}Connected as: ${BOLD}${GREEN}${DOMAIN}${RESET}"
    echo -e "${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
    echo ""
    echo -e "  ${CYAN}[1]${RESET} ${BOLD}AI Models${RESET}         - Start a conversation"
    echo -e "  ${CYAN}[2]${RESET} ${BOLD}Chats${RESET}             - History and logs"
    echo -e "  ${CYAN}[3]${RESET} ${BOLD}Files${RESET}             - Workspace browser"
    echo -e "  ${CYAN}[4]${RESET} ${BOLD}Events${RESET}            - View and schedule tasks"
    echo -e "  ${CYAN}[5]${RESET} ${BOLD}Services${RESET}          - Manage services"
    echo -e "  ${CYAN}[6]${RESET} ${BOLD}Billing${RESET}           - Credits and usage"
    echo -e "  ${CYAN}[7]${RESET} ${BOLD}System${RESET}            - View machine stats"
    echo -e "  ${CYAN}[8]${RESET} ${BOLD}Mount${RESET}             - Mount workspace as drive"
    echo -e "  ${CYAN}[9]${RESET} ${BOLD}Exit${RESET}              - Close application"
    echo ""
    echo -e "${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
    echo ""
    echo -n "Choice: "
    read main_choice
    # Strip whitespace/newlines
    main_choice=$(echo "$main_choice" | tr -d '[:space:]')

    case $main_choice in
        1)
            # Continue to AI model selection
            break
            ;;
        2)
            # Chats / History
            while true; do
                clear
                echo -e "${CYAN}"
                cat << "BANNER"
     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
    â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•
    â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
    â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â•šâ•â•â•â•â–ˆâ–ˆâ•‘
    â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
     â•šâ•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•   â•šâ•â•   â•šâ•â•â•â•â•â•â•
BANNER
                echo -e "${RESET}"
                echo ""
                echo -e "${BOLD}           Conversation History${RESET}"
                echo ""
                echo -e "${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
                echo ""
                echo -e "  ${CYAN}[1]${RESET} ${BOLD}Chats${RESET}             - AI conversations"
                echo -e "  ${CYAN}[2]${RESET} ${BOLD}Emails${RESET}            - Email logs"
                echo -e "  ${CYAN}[3]${RESET} ${BOLD}Agents${RESET}            - Agent activities"
                echo -e "  ${CYAN}[4]${RESET} ${BOLD}Texts${RESET}             - SMS logs"
                echo -e "  ${CYAN}[5]${RESET} ${BOLD}Back${RESET}              - Return to main menu"
                echo ""
                echo -e "${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
                echo ""
                echo -n "Choice: "
                read chat_type_choice
                
                case $chat_type_choice in
                    1) type_param="chat"; type_label="Chats" ;;
                    2) type_param="email"; type_label="Emails" ;;
                    3) type_param="agent"; type_label="Agents" ;;
                    4) type_param="text"; type_label="Texts" ;;
                    5) break ;;
                    *) echo "Invalid choice"; sleep 1; continue ;;
                esac
                
                # Fix for SMS type
                if [ "$type_param" = "text" ]; then
                    type_param="sms"
                fi
                
                # Fetch conversations
                echo ""
                echo -e "${YELLOW}Fetching $type_label...${RESET}"
                
                convs_resp=$(curl -s -X GET "$API_BASE/conversations?limit=50&offset=0&conversation_type=$type_param" \
                    -H "cookie: access_token=$ACCESS_TOKEN" \
                    -H "origin: https://$DOMAIN")
                
                if command -v jq > /dev/null 2>&1; then
                    # Check if response is an array
                    is_array=$(echo "$convs_resp" | jq 'if type=="array" then "yes" else "no" end' -r 2>/dev/null)
                    
                    if [ "$is_array" != "yes" ]; then
                        echo -e "${RED}Error: Invalid API response format.${RESET}"
                        echo -e "${DIM}Response: $convs_resp${RESET}"
                        read -n 1 -s -r -p "Press any key to continue..."
                        continue
                    fi

                    conv_count=$(echo "$convs_resp" | jq '. | length' 2>/dev/null)
                    
                    if [ "$conv_count" = "0" ] || [ -z "$conv_count" ]; then
                        echo -e "${DIM}No conversations found.${RESET}"
                        read -n 1 -s -r -p "Press any key to continue..."
                        continue
                    fi
                    
                    # Show list
                    while true; do
                        clear
                        echo -e "${BOLD}           $type_label List${RESET}"
                        echo -e "${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
                        
                        # Display first 20 or so
                        for i in $(seq 0 $(($conv_count - 1))); do
                            id=$(echo "$convs_resp" | jq -r ".[$i].id")
                            title=$(echo "$convs_resp" | jq -r ".[$i].title // \"Untitled\"")
                            date=$(echo "$convs_resp" | jq -r ".[$i].created_at")
                            # Simple date format cleanup if possible, else raw
                            date_short=$(echo "$date" | cut -d'T' -f1)
                            
                            printf "  ${CYAN}[%d]${RESET} %-40s ${DIM}%s${RESET}\n" $((i+1)) "${title:0:40}" "$date_short"
                        done
                        echo ""
                        echo -e "${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
                        echo -e "${DIM}Enter number to view, or 'b' to back${RESET}"
                        echo -n "Select: "
                        read sel_conv
                        
                        if [ "$sel_conv" = "b" ]; then
                            break
                        fi
                        
                        if [[ "$sel_conv" =~ ^[0-9]+$ ]] && [ "$sel_conv" -ge 1 ] && [ "$sel_conv" -le "$conv_count" ]; then
                            idx=$(($sel_conv - 1))
                            conv_id=$(echo "$convs_resp" | jq -r ".[$idx].id")
                            
                            # Fetch details
                            echo ""
                            echo -e "${YELLOW}Loading conversation...${RESET}"
                            
                            detail_resp=$(curl -s -X GET "$API_BASE/conversations/$conv_id" \
                                -H "cookie: access_token=$ACCESS_TOKEN" \
                                -H "origin: https://$DOMAIN")
                                
                            # Parse messages
                            # We want to extract parts from messages array
                            # Message structure: .messages[].parts[].content
                            # Filter by part_kind: user-prompt or text
                            
                            clear
                            echo -e "${BOLD}Conversation View${RESET}"
                            echo -e "${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
                            
                            echo "$detail_resp" | jq -r '.messages[] | .parts[] | select(.part_kind=="user-prompt" or .part_kind=="text") | "\(.part_kind): \(.content)\n---"' | while read -r line; do
                                if [[ "$line" == "user-prompt:"* ]]; then
                                    content=${line#user-prompt: }
                                    echo -e "${BOLD}User:${RESET}"
                                    echo -e "$content"
                                    echo ""
                                elif [[ "$line" == "text:"* ]]; then
                                    content=${line#text: }
                                    echo -e "${CYAN}AI:${RESET}"
                                    echo -e "$content"
                                    echo ""
                                elif [[ "$line" == "---" ]]; then
                                    echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
                                fi
                            done 2>/dev/null
                            
                            echo ""
                            read -n 1 -s -r -p "Press any key to return to list..."
                        else
                            echo "Invalid selection"
                            sleep 1
                        fi
                    done
                else
                    echo -e "${RED}Error: jq not installed.${RESET}"
                    read -n 1 -s -r -p "Press any key to continue..."
                fi
            done
            ;;
        3)
            # File Manager
            while true; do
                clear
                echo -e "${CYAN}"
                cat << "BANNER"
     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
     â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•
     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
     â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â•  â•šâ•â•â•â•â–ˆâ–ˆâ•‘
     â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
     â•šâ•â•     â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â•
BANNER
                echo -e "${RESET}"
                echo ""
                echo -e "${BOLD}           Workspace Browser${RESET}"
                echo ""
                echo -e "${YELLOW}Fetching file tree...${RESET}"
                
                # Fetch file tree
                # Using the user's domain for this specific endpoint as discovered
                files_resp=$(curl -s -X GET "https://$DOMAIN/api/workspace-tree?root=w&showHidden=false" \
                    -H "cookie: access_token=$ACCESS_TOKEN" \
                    -H "origin: https://$DOMAIN")
                
                if command -v jq > /dev/null 2>&1; then
                    # Check if response is valid
                    is_valid=$(echo "$files_resp" | jq 'if .name then "yes" else "no" end' -r 2>/dev/null)
                    
                    if [ "$is_valid" != "yes" ]; then
                        echo -e "${RED}Error: Failed to fetch file tree.${RESET}"
                        echo -e "${DIM}Response: $files_resp${RESET}"
                        read -n 1 -s -r -p "Press any key to return..."
                        break
                    fi
                    
                    # Simple navigation loop
                    current_path="root"
                    # We'll use a simplified approach: just list the root for now as full navigation 
                    # requires complex state management in bash or recursive parsing.
                    # For V1, we list the top-level items.
                    
                    echo -e "${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
                    echo -e "${BOLD}Path: /${RESET}"
                    echo -e "${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
                    
                    # List directories first
                    echo "$files_resp" | jq -r '.children[] | select(.type=="directory") | "\(.name)/"' | while read -r line; do
                        echo -e "  ${BLUE}ğŸ“‚ $line${RESET}"
                    done
                    
                    # List files
                    echo "$files_resp" | jq -r '.children[] | select(.type=="file") | "\(.name)"' | while read -r line; do
                        echo -e "  ${WHITE}ğŸ“„ $line${RESET}"
                    done
                    
                    echo ""
                    echo -e "${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
                    echo -e "${DIM}(Navigation coming in v2)${RESET}"
                else
                    echo -e "${RED}Error: jq not installed.${RESET}"
                fi
                
                echo ""
                read -n 1 -s -r -p "Press any key to return to main menu..."
                break
            done
            ;;
        4)
            # Events Management
            while true; do
                clear
                echo -e "${MAGENTA}"
                cat << "BANNER"
    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
    â•šâ•â•â–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ•â•â–ˆâ–ˆâ•”â•â•â•
      â–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   
     â–ˆâ–ˆâ–ˆâ•”â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   
    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•    â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   
    â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â•      â•šâ•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•   â•šâ•â•   
        /horse)
            clear
            echo -e "${CYAN}"
            cat << 'HORSE'
                                                                         
                                     <k@$$$$$$$$$$$$$$$$_               
                   )/ckWBB@x.      ($$$$$$$$$$$$$$$$$$$@.               
                  b$$$@BBM_\@%    ~B$$$$$$$$$$$$$$$$$$$h                
                  b<[@$$$$$@L(B\. \$$$$$$$$$$$$$$$$$$@W                 
                  bvC@@$$$$$$B`Bb t$$$$$$$$$$$$$$$$$8'.                 
                  b@#. :@$$$$$@ @Ou$$$$$$@$@$$@@ot                      
                  w^m,  f@$@."\'`zm$$@.                                 
                   ..   /@$$$$$$@^@$$#                                  
                 .h$@C .@$$$$$B^h@@@@i                                  
                 lBu@W.>\B$$$$@bbkhBB                                   
                .@Y  lB@@"B$$$@@$$$$@@                                  
                &&. .@+.@$^$$@"B$$$$@XwqZ(.                             
               .8O, hQ  IBBBBn#@$$$$$$$$$$$B@B@BBi                      
                   nd        b@@@$@@@@$$$$$$$@'@$@{                     
                   [@q'         .O8'8@$$$$$$$@ $$$&                     
                     ..       "@%"@$$$$$$$$$^ $$$&                     
                             M$$@X@$$$$$@h(    $$$&                     
                             B$$$O_B$$$B       $$$&                     
                              f@@h. ?@@*       @$$&                     
                                d@j   ?B@W     YB$&                     
                              -B@"    *BJ       "@B}                    
                           .]@8    .&@C                                 
                          _Bw^    MBJ                                   
                         tttl   a@@B'                                   
                                                                         
HORSE
            echo -e "${RESET}"
            echo -e "${DIM}            The legendary Zo Computer steed${RESET}"
            echo ""
            read -n 1 -s -r -p "Press any key to continue..."
            ;;
        5)
            # User Services Management
            while true; do
                clear
                echo -e "${MAGENTA}"
                cat << "BANNER"
    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
    â•šâ•â•â–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ•â•â–ˆâ–ˆâ•”â•â•â•
      â–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   
     â–ˆâ–ˆâ–ˆâ•”â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   
    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•    â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   
    â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â•      â•šâ•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•   â•šâ•â•   
BANNER
                echo -e "${RESET}"
                echo ""
                echo -e "${BOLD}           User Services${RESET}"
                echo ""
                echo -e "${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
                echo ""
                echo -e "  ${CYAN}[1]${RESET} ${BOLD}List Services${RESET}   - View all services"
                echo -e "  ${CYAN}[2]${RESET} ${BOLD}Create Service${RESET}  - Deploy new service"
                echo -e "  ${CYAN}[3]${RESET} ${BOLD}Back${RESET}            - Return to main menu"
                echo ""
                echo -e "${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
                echo ""
                echo -n "Choice: "
                read service_choice
                
                case $service_choice in
                    1)
                        # List services
                        echo ""
                        echo -e "${YELLOW}Fetching services...${RESET}"
                        echo ""
                        
                        services=$(curl -s -X GET "$API_BASE/user-services/" \
                            -H "cookie: access_token=$ACCESS_TOKEN" \
                            -H "origin: https://$DOMAIN")
                        
                        if command -v jq > /dev/null 2>&1; then
                            # Check if response is an array
                            is_array=$(echo "$services" | jq 'if type=="array" then "yes" else "no" end' -r 2>/dev/null)
                            
                            if [ "$is_array" = "yes" ]; then
                                service_count=$(echo "$services" | jq '. | length' 2>/dev/null)
                                
                                if [ "$service_count" = "0" ] || [ -z "$service_count" ]; then
                                    echo -e "${DIM}No services found.${RESET}"
                                else
                                    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
                                    echo -e "  ${BOLD}Active Services ($service_count)${RESET}"
                                    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
                                    
                                    # Loop through services using base64 to handle special chars safely
                                    for i in $(seq 0 $(($service_count - 1))); do
                                        # Extract fields safely
                                        label=$(echo "$services" | jq -r ".[$i].label // \"Unknown\"")
                                        protocol=$(echo "$services" | jq -r ".[$i].protocol // \"tcp\"")
                                        port=$(echo "$services" | jq -r ".[$i].local_port // \"N/A\"")
                                        http_url=$(echo "$services" | jq -r ".[$i].http_url")
                                        tcp_addr=$(echo "$services" | jq -r ".[$i].tcp_addr")
                                        
                                        # Determine status
                                        if [ "$http_url" != "null" ] && [ -n "$http_url" ]; then
                                            # Check HTTP health
                                            # Use --max-time 2 to avoid hanging
                                            http_code=$(curl -s -o /dev/null -w "%{http_code}" --max-time 2 "$http_url")
                                            
                                            if [[ "$http_code" =~ ^[23] ]]; then
                                                status_icon="${GREEN}â—${RESET}"
                                                status_text="${GREEN}Online ($http_code)${RESET}"
                                            else
                                                status_icon="${RED}â—${RESET}"
                                                status_text="${RED}Offline ($http_code)${RESET}"
                                            fi
                                        else
                                            # TCP service - cannot easily check from here without nc/telnet
                                            # Assume running if it exists in the list
                                            status_icon="${BLUE}â—${RESET}"
                                            status_text="${BLUE}Running${RESET}"
                                        fi
                                        
                                        echo ""
                                        echo -e "  $status_icon ${BOLD}$label${RESET} ${DIM}($protocol:$port)${RESET}"
                                        echo -e "      Status: $status_text"
                                        
                                        if [ "$http_url" != "null" ] && [ -n "$http_url" ]; then
                                            echo -e "      ${CYAN}URL:${RESET}    $http_url"
                                        fi
                                        
                                        if [ "$tcp_addr" != "null" ] && [ -n "$tcp_addr" ]; then
                                            echo -e "      ${CYAN}TCP:${RESET}    $tcp_addr"
                                        fi
                                    done
                                    
                                    echo ""
                                    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
                                fi
                            else
                                echo -e "${RED}Error: Invalid API response format.${RESET}"
                                echo -e "${DIM}Response: $services${RESET}"
                            fi
                        else
                            echo -e "${RED}Error: jq not installed. Cannot parse services.${RESET}"
                        fi
                        echo ""
                        read -n 1 -s -r -p "Press any key to continue..."
                        ;;
                    2)
                        # Create service
                        echo ""
                        echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
                        echo -e "  ${BOLD}Create New Service${RESET}"
                        echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
                        echo ""
                        echo -n "Service label: "
                        read svc_label
                        echo -n "Protocol (http/tcp): "
                        read svc_protocol
                        echo -n "Local port: "
                        read svc_port
                        echo -n "Entrypoint command: "
                        read svc_entrypoint
                        echo -n "Working directory: "
                        read svc_workdir
                        
                        # Construct JSON payload
                        # Use jq to create safe JSON if available, otherwise manual string construction
                        if command -v jq > /dev/null 2>&1; then
                            service_json=$(jq -n \
                                --arg label "$svc_label" \
                                --arg protocol "$svc_protocol" \
                                --argjson port "$svc_port" \
                                --arg entrypoint "$svc_entrypoint" \
                                --arg workdir "$svc_workdir" \
                                '{label: $label, protocol: $protocol, local_port: $port, entrypoint: $entrypoint, workdir: $workdir}')
                        else
                            service_json="{\"label\":\"$svc_label\",\"protocol\":\"$svc_protocol\",\"local_port\":$svc_port,\"entrypoint\":\"$svc_entrypoint\",\"workdir\":\"$svc_workdir\"}"
                        fi
                        
                        echo ""
                        echo -e "${YELLOW}Creating service...${RESET}"
                        
                        result=$(curl -s -X POST "$API_BASE/user-services/" \
                            -H "content-type: application/json" \
                            -H "cookie: access_token=$ACCESS_TOKEN" \
                            -H "origin: https://$DOMAIN" \
                            -d "$service_json")
                            
                        # Check if successful (simple check for service_id in response)
                        if echo "$result" | grep -q "service_id"; then
                            echo ""
                            echo -e "${GREEN}âœ“ Service created successfully!${RESET}"
                        else
                            echo ""
                            echo -e "${RED}âœ— Failed to create service.${RESET}"
                            echo -e "${DIM}Response: $result${RESET}"
                        fi
                        
                        echo ""
                        read -n 1 -s -r -p "Press any key to continue..."
                        ;;
                    3)
                        break
                        ;;
                    *)
                        echo "Invalid choice"
                        sleep 1
                        ;;
                esac
            done
            ;;
        6)
            # View billing information
            echo ""
            echo -e "${YELLOW}Fetching billing information...${RESET}"
            echo ""
            
            billing=$(curl -s -X GET "$API_BASE/billing/usage-alert" \
                -H "cookie: access_token=$ACCESS_TOKEN" \
                -H "origin: https://$DOMAIN")
            
            usage_data=$(curl -s -X GET "$API_BASE/billing/meter-usage?meter_kind=chat&timezone=America%2FChicago" \
                -H "cookie: access_token=$ACCESS_TOKEN" \
                -H "origin: https://$DOMAIN")
            
            if command -v jq > /dev/null 2>&1; then
                credits_cents=$(echo "$billing" | jq -r '.remaining_credits_amount_cents' 2>/dev/null)
                credits_dollars=$(awk "BEGIN {printf \"%.2f\", $credits_cents / 100}")
                
                invoice_total=$(echo "$billing" | jq -r '.upcoming_invoice.total_display' 2>/dev/null)
                next_payment=$(echo "$billing" | jq -r '.upcoming_invoice.next_payment_attempt' 2>/dev/null)
                
                echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
                echo -e "  ${BOLD}Billing Overview${RESET}"
                echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
                echo ""
                echo -e "  ${BOLD}Credit Balance:${RESET} ${GREEN}\$$credits_dollars${RESET}"
                echo -e "  ${BOLD}Next Invoice:${RESET}   ${YELLOW}$invoice_total${RESET}"
                echo ""
                
                # Token usage chart
                data_count=$(echo "$usage_data" | jq -r '.data | length' 2>/dev/null)
                
                if [ "$data_count" -gt 0 ]; then
                    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
                    echo -e "  ${BOLD}Token Usage Chart (Last 24h)${RESET}"
                    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
                    echo ""
                    
                    # Find max value for scaling
                    max_value=0
                    for i in $(seq 0 $(($data_count - 1))); do
                        value=$(echo "$usage_data" | jq -r ".data[$i].bucket_value" 2>/dev/null)
                        value=${value%.*}  # Remove decimal
                        [ $value -gt $max_value ] && max_value=$value
                    done
                    
                    # Show last 20 data points
                    start_idx=$(($data_count - 20))
                    [ $start_idx -lt 0 ] && start_idx=0
                    
                    for i in $(seq $start_idx $(($data_count - 1))); do
                        timestamp=$(echo "$usage_data" | jq -r ".data[$i].bucket_start_time" 2>/dev/null)
                        value=$(echo "$usage_data" | jq -r ".data[$i].bucket_value" 2>/dev/null)
                        value=${value%.*}
                        
                        # Format time (HH:MM)
                        time_str=$(date -d @$timestamp +"%H:%M" 2>/dev/null || echo "??:??")
                        
                        # Calculate bar width (max 40 chars)
                        if [ $max_value -gt 0 ]; then
                            bar_width=$((value * 40 / max_value))
                        else
                            bar_width=0
                        fi
                        
                        # Create bar
                        bar=""
                        for ((j=0; j<bar_width; j++)); do
                            bar+="â–ˆ"
                        done
                        
                        # Format value with K suffix if large
                        if [ $value -gt 10000 ]; then
                            value_display=$(awk "BEGIN {printf \"%.1fK\", $value / 1000}")
                        else
                            value_display=$(printf "%'d" $value 2>/dev/null || echo $value)
                        fi
                        
                        printf "  ${DIM}%5s${RESET} ${GREEN}%-40s${RESET} ${CYAN}%8s${RESET}\n" "$time_str" "$bar" "$value_display"
                    done
                    
                    echo ""
                fi
                
                # Show usage breakdown
                period_count=$(echo "$billing" | jq -r '.upcoming_invoice.periods | length' 2>/dev/null)
                
                if [ "$period_count" -gt 0 ]; then
                    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
                    echo -e "  ${BOLD}Usage Breakdown${RESET}"
                    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
                    
                    for period_idx in $(seq 0 $(($period_count - 1))); do
                        period_label=$(echo "$billing" | jq -r ".upcoming_invoice.periods[$period_idx].label" 2>/dev/null)
                        line_count=$(echo "$billing" | jq -r ".upcoming_invoice.periods[$period_idx].lines | length" 2>/dev/null)
                        
                        echo ""
                        echo -e "  ${BOLD}$period_label${RESET}"
                        
                        for line_idx in $(seq 0 $(($line_count - 1))); do
                            desc=$(echo "$billing" | jq -r ".upcoming_invoice.periods[$period_idx].lines[$line_idx].description" 2>/dev/null)
                            qty=$(echo "$billing" | jq -r ".upcoming_invoice.periods[$period_idx].lines[$line_idx].quantity" 2>/dev/null)
                            amount=$(echo "$billing" | jq -r ".upcoming_invoice.periods[$period_idx].lines[$line_idx].amount_display" 2>/dev/null)
                            
                            # Format quantity with commas
                            qty_formatted=$(printf "%'d" $qty 2>/dev/null || echo $qty)
                            
                            printf "    ${DIM}%-35s${RESET} %15s  ${GREEN}%8s${RESET}\n" "$desc" "$qty_formatted" "$amount"
                        done
                    done
                    
                    echo ""
                    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
                fi
            else
                echo -e "${RED}Error: jq not installed. Cannot parse billing data.${RESET}"
            fi
            echo ""
            read -n 1 -s -r -p "Press any key to continue..."
            ;;
        7)
            # System Stats
            clear
            echo -e "${CYAN}"
            cat << 'HORSE'
                                                                         
                                     <k@$$$$$$$$$$$$$$$$_               
                   )/ckWBB@x.      ($$$$$$$$$$$$$$$$$$$@.               
                  b$$$@BBM_\@%    ~B$$$$$$$$$$$$$$$$$$$h                
                  b<[@$$$$$@L(B\. \$$$$$$$$$$$$$$$$$$@W                 
                  bvC@@$$$$$$B`Bb t$$$$$$$$$$$$$$$$$8'.                 
                  b@#. :@$$$$$@ @Ou$$$$$$@$@$$@@ot                      
                  w^m,  f@$@."\'`zm$$@.                                 
                   ..   /@$$$$$$@^@$$#                                  
                 .h$@C .@$$$$$B^h@@@@i                                  
                 lBu@W.>\B$$$$@bbkhBB                                   
                .@Y  lB@@"B$$$@@$$$$@@                                  
                &&. .@+.@$^$$@"B$$$$@XwqZ(.                             
               .8O, hQ  IBBBBn#@$$$$$$$$$$$B@B@BBi                      
                   nd        b@@@$@@@@$$$$$$$@'@$@{                     
                   [@q'         .O8'8@$$$$$$$@ $$$&                     
                     ..       "@%"@$$$$$$$$$^ $$$&                     
                             M$$@X@$$$$$@h(    $$$&                     
                             B$$$O_B$$$B       $$$&                     
                              f@@h. ?@@*       @$$&                     
                                d@j   ?B@W     YB$&                     
                              -B@"    *BJ       "@B}                    
                           .]@8    .&@C                                 
                          _Bw^    MBJ                                   
                         tttl   a@@B'                                   
                                                                         
HORSE
            echo -e "${RESET}"
            echo -e "${BOLD}           System Statistics${RESET}"
            echo ""
            echo -e "${YELLOW}Fetching metrics...${RESET}"
            
            # Call /exec API
            stats_resp=$(curl -s -X POST "$API_BASE/exec" \
                -H "content-type: application/json" \
                -H "cookie: access_token=$ACCESS_TOKEN" \
                -H "origin: https://$DOMAIN" \
                -d '{"command": "uv run /__substrate/sys_stats.py --measure_speed"}')
            
            # Extract stdout which contains the actual JSON data
            stats_json=$(echo "$stats_resp" | jq -r '.stdout' 2>/dev/null)
            
            if [ -n "$stats_json" ] && [ "$stats_json" != "null" ]; then
                # Parse metrics
                os_name=$(echo "$stats_json" | jq -r '.os' 2>/dev/null)
                os_ver=$(echo "$stats_json" | jq -r '.os_version' 2>/dev/null)
                arch=$(echo "$stats_json" | jq -r '.arch' 2>/dev/null)
                
                cpu_cores=$(echo "$stats_json" | jq -r '.cpu.physical_cores' 2>/dev/null)
                cpu_usage=$(echo "$stats_json" | jq -r '.cpu.usage_percent' 2>/dev/null)
                
                mem_total=$(echo "$stats_json" | jq -r '.memory.total_gb' 2>/dev/null)
                mem_used=$(echo "$stats_json" | jq -r '.memory.used_gb' 2>/dev/null)
                mem_pct=$(echo "$stats_json" | jq -r '.memory.percent' 2>/dev/null)
                
                disk_total=$(echo "$stats_json" | jq -r '.disks["/"].total_gb' 2>/dev/null)
                disk_used=$(echo "$stats_json" | jq -r '.disks["/"].used_gb' 2>/dev/null)
                disk_pct=$(echo "$stats_json" | jq -r '.disks["/"].percent' 2>/dev/null)
                
                dl_speed=$(echo "$stats_json" | jq -r '.network.download_mbps' 2>/dev/null)
                ul_speed=$(echo "$stats_json" | jq -r '.network.upload_mbps' 2>/dev/null)
                
                uptime_sec=$(echo "$stats_json" | jq -r '.uptime_seconds' 2>/dev/null)
                uptime_hrs=$(awk "BEGIN {printf \"%.1f\", $uptime_sec / 3600}")
                
                echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
                echo -e "  ${BOLD}System Information${RESET}"
                echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
                echo -e "  ${BOLD}OS:${RESET}        $os_name $os_ver ($arch)"
                echo -e "  ${BOLD}Uptime:${RESET}    ${uptime_hrs} hours"
                echo ""
                echo -e "  ${BOLD}CPU:${RESET}       ${cpu_usage}% (${cpu_cores} Cores)"
                echo -e "  ${BOLD}Memory:${RESET}    ${mem_used}GB / ${mem_total}GB (${mem_pct}%)"
                echo -e "  ${BOLD}Disk:${RESET}      ${disk_used}GB / ${disk_total}GB (${disk_pct}%)"
                echo ""
                echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
                echo -e "  ${BOLD}Network Speed${RESET}"
                echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
                echo -e "  ${BOLD}Download:${RESET}  ${GREEN}${dl_speed} Mbps${RESET}"
                echo -e "  ${BOLD}Upload:${RESET}    ${GREEN}${ul_speed} Mbps${RESET}"
                echo ""
            else
                echo -e "${RED}Failed to retrieve system stats.${RESET}"
            fi
            
            read -n 1 -s -r -p "Press any key to continue..."
            ;;
        8)
            # Mount Filesystem
            clear
            echo -e "${GREEN}"
            cat << "BANNER"
     â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
     â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â•šâ•â•â–ˆâ–ˆâ•”â•â•â•
     â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   
     â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   
     â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   
     â•šâ•â•     â•šâ•â• â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•â•   â•šâ•â•   
BANNER
            echo -e "${RESET}"
            echo ""
            echo -e "${BOLD}           Mount Workspace${RESET}"
            echo ""
            echo -e "${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
            echo ""
            echo -e "This will mount your Zo Computer workspace as a network drive."
            echo ""
            echo -e "${YELLOW}Requirements:${RESET}"
            echo -e "  â€¢ Python 3.7+"
            echo -e "  â€¢ pip (Python package manager)"
            echo ""
            echo -e "${YELLOW}Mount points:${RESET}"
            echo -e "  â€¢ macOS/Linux: ~/zoMount"
            echo -e "  â€¢ Windows:     Z:"
            echo ""
            echo -e "${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
            echo ""
            
            # Check if mount helper exists
            if [ ! -f "$(dirname "$0")/mount_zo" ]; then
                echo -e "${RED}Error: mount_zo script not found${RESET}"
                echo ""
                read -n 1 -s -r -p "Press any key to continue..."
                continue
            fi
            
            echo -n "Start mounting? [y/N]: "
            read -n 1 mount_confirm
            echo ""
            
            if [[ "$mount_confirm" =~ ^[Yy]$ ]]; then
                echo ""
                echo -e "${CYAN}Starting mount process...${RESET}"
                echo ""
                
                # Run mount script
                bash "$(dirname "$0")/mount_zo" mount
                
                echo ""
                read -n 1 -s -r -p "Press any key to continue..."
            fi
            ;;
        9)
            echo ""
            echo -e "${DIM}Goodbye!${RESET}"
            echo ""
            exit 0
            ;;
        *)
            echo "Invalid choice"
            sleep 1
            ;;
    esac
done

# Model Selection
clear
echo -e "${CYAN}"
cat << "BANNER"
   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
   â•šâ•â•â–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ•â•â–ˆâ–ˆâ•”â•â•â•
     â–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   
    â–ˆâ–ˆâ–ˆâ•”â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   
   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•    â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   
   â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â•      â•šâ•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•   â•šâ•â•   
BANNER
echo -e "${RESET}"
echo ""
echo -e "${BOLD}${CYAN}                    Select Your AI Model${RESET}"
echo ""
echo -e "${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
echo ""
echo -e "  ${CYAN}[1]${RESET} ${BOLD}GPT-5.1${RESET}        - OpenAI's latest flagship"
echo -e "  ${CYAN}[2]${RESET} ${BOLD}GPT-5 Mini${RESET}     - Fast and efficient"
echo -e "  ${CYAN}[3]${RESET} ${BOLD}Claude Haiku${RESET}   - Anthropic's smart assistant"
echo -e "  ${CYAN}[4]${RESET} ${BOLD}Grok 4${RESET}         - xAI's reasoning powerhouse"
echo -e "  ${CYAN}[5]${RESET} ${BOLD}Gemini 3 Pro${RESET}   - Google's advanced model"
echo -e "  ${CYAN}[6]${RESET} ${BOLD}GLM-4.6${RESET}        - Z-AI's exacto model"
echo -e "  ${CYAN}[7]${RESET} ${BOLD}Kimi K2${RESET}        - Moonshot's thinking model"
echo -e "  ${CYAN}[8]${RESET} ${BOLD}GPT-5.1 Codex${RESET} - OpenAI's code specialist"
echo -e "  ${CYAN}[9]${RESET} ${BOLD}Claude Opus 4.5${RESET} - Anthropic's most capable"
echo -e "  ${CYAN}[10]${RESET} ${BOLD}Claude Sonnet 4.5${RESET} - Balanced performance"
echo -e "  ${CYAN}[11]${RESET} ${BOLD}Claude Sonnet 4${RESET} - Reliable assistant"
echo -e "  ${CYAN}[12]${RESET} ${BOLD}Back${RESET}            - Return to main menu"
echo ""
echo -e "${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
echo ""
echo -n "Choice: "
read choice
case $choice in
    1) 
        model="openai:gpt-5.1-2025-11-13"; name="GPT-5.1"; color=$GREEN
        # GPT-5.1 Reasoning Level Selection
        clear
        echo -e "${GREEN}"
        cat << "BANNER"
   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
  â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ•â•â–ˆâ–ˆâ•”â•â•â•
  â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   
  â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   
  â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   
   â•šâ•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•   â•šâ•â•   
BANNER
        echo -e "${RESET}"
        echo ""
        echo -e "${BOLD}           Select Reasoning Depth${RESET}"
        echo ""
        echo -e "${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
        echo ""
        echo -e "  ${GREEN}[0]${RESET} ${BOLD}Quick Mode${RESET}      - Fast responses, minimal reasoning"
        echo -e "  ${GREEN}[1]${RESET} ${BOLD}Balanced Mode${RESET}   - Moderate reasoning depth"
        echo -e "  ${GREEN}[2]${RESET} ${BOLD}Deep Thinking${RESET}   - Maximum reasoning power"
        echo ""
        echo -e "${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
        echo ""
        echo -e "${DIM}Type '/exit' anytime to return to main menu${RESET}"
        echo ""
        echo -n "Reasoning Level: "
        read reasoning_choice
        
        # Check for /exit
        if [ "$reasoning_choice" = "/exit" ]; then
            exec "$0"
        fi
        
        case $reasoning_choice in
            0) reasoning_level=0; reasoning_name="Quick" ;;
            1) reasoning_level=1; reasoning_name="Balanced" ;;
            2) reasoning_level=2; reasoning_name="Deep" ;;
            *) reasoning_level=1; reasoning_name="Balanced" ;;
        esac
        
        echo ""
        echo -e "${BOLD}           Select Verbosity Level${RESET}"
        echo ""
        echo -e "${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
        echo ""
        echo -e "  ${GREEN}[1]${RESET} ${BOLD}Low${RESET}      - Concise responses"
        echo -e "  ${GREEN}[2]${RESET} ${BOLD}Medium${RESET}   - Standard detail"
        echo -e "  ${GREEN}[3]${RESET} ${BOLD}High${RESET}     - Detailed explanations"
        echo ""
        echo -e "${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
        echo ""
        echo -e "${DIM}Type '/exit' anytime to return to main menu${RESET}"
        echo ""
        echo -n "Verbosity: "
        read verbosity_choice
        
        # Check for /exit
        if [ "$verbosity_choice" = "/exit" ]; then
            exec "$0"
        fi
        
        case $verbosity_choice in
            1) verbosity_level="low" ;;
            2) verbosity_level="medium" ;;
            3) verbosity_level="high" ;;
            *) verbosity_level="low" ;;
        esac
        
        model_settings="{\"reasoning\":{\"kind\":\"level\",\"level\":$reasoning_level},\"verbosity\":\"$verbosity_level\"}"
        name="GPT-5.1 ($reasoning_name)"
        ;;
    2) 
        model="openai:gpt-5-mini-2025-08-07"; name="GPT-5 Mini"; color=$BLUE
        model_settings="{}"
        ;;
    4) 
        model="anthropic:claude-haiku-4-5-20251001"; name="Claude Haiku"; color=$MAGENTA
        # Claude Haiku Token Budget Selection
        clear
        echo -e "${MAGENTA}"
        cat << "BANNER"
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘                                                           â•‘
    â•‘              CLAUDE HAIKU TOKEN BUDGET                    â•‘
    â•‘                                                           â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
BANNER
        echo -e "${RESET}"
        echo ""
        echo -e "${BOLD}           Select Token Budget${RESET}"
        echo ""
        echo -e "${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
        echo ""
        echo -e "  ${MAGENTA}[1]${RESET} ${BOLD}15,000 Tokens${RESET}   - Faster, lighter responses"
        echo -e "  ${MAGENTA}[2]${RESET} ${BOLD}30,000 Tokens${RESET}   - Extended thinking capacity"
        echo ""
        echo -e "${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
        echo ""
        echo -e "${DIM}Type '/exit' anytime to return to main menu${RESET}"
        echo ""
        echo -n "Token Budget: "
        read budget_choice
        
        # Check for /exit
        if [ "$budget_choice" = "/exit" ]; then
            exec "$0"
        fi
        
        case $budget_choice in
            1) token_budget=15000; budget_name="15k" ;;
            2) token_budget=30000; budget_name="30k" ;;
            *) token_budget=15000; budget_name="15k" ;;
        esac
        
        model_settings="{\"reasoning\":{\"kind\":\"budget_tokens\",\"tokens\":$token_budget},\"verbosity\":null}"
        name="Claude Haiku ($budget_name)"
        ;;
    8) 
        model="grok-4-1-fast-reasoning"; name="Grok 4"; color=$CYAN
        model_settings="{}"
        ;;
    9) 
        model="google-vertex:gemini-3-pro-preview"; name="Gemini 3 Pro"; color=$YELLOW
        model_settings="{}"
        ;;
    10) 
        model="openrouter:z-ai/glm-4.6:exacto:floor"; name="GLM-4.6"; color=$CYAN
        model_settings="{}"
        ;;
    11) 
        model="openrouter:moonshotai/kimi-k2-thinking:floor"; name="Kimi K2"; color=$MAGENTA
        model_settings="{}"
        ;;
    3) 
        model="openai:gpt-5.1-codex-mini"; name="GPT-5.1 Codex"; color=$GREEN
        model_settings="{}"
        ;;
    5) 
        model="anthropic:claude-opus-4-5-20251101"; name="Claude Opus 4.5"; color=$MAGENTA
        model_settings="{}"
        ;;
    6) 
        model="anthropic:claude-sonnet-4-5-20250929"; name="Claude Sonnet 4.5"; color=$MAGENTA
        # Claude Sonnet 4.5 Token Budget Selection
        clear
        echo -e "${MAGENTA}"
        cat << "BANNER"
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘                                                           â•‘
    â•‘          CLAUDE SONNET 4.5 TOKEN BUDGET                   â•‘
    â•‘                                                           â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
BANNER
        echo -e "${RESET}"
        echo ""
        echo -e "${BOLD}           Select Token Budget${RESET}"
        echo ""
        echo -e "${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
        echo ""
        echo -e "  ${MAGENTA}[0]${RESET} ${BOLD}No Budget${RESET}       - Standard mode (0 tokens)"
        echo -e "  ${MAGENTA}[1]${RESET} ${BOLD}15,000 Tokens${RESET}   - Faster, lighter responses"
        echo -e "  ${MAGENTA}[2]${RESET} ${BOLD}30,000 Tokens${RESET}   - Extended thinking capacity"
        echo ""
        echo -e "${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
        echo ""
        echo -e "${DIM}Type '/exit' anytime to return to main menu${RESET}"
        echo ""
        echo -n "Token Budget: "
        read budget_choice
        
        # Check for /exit
        if [ "$budget_choice" = "/exit" ]; then
            exec "$0"
        fi
        
        case $budget_choice in
            0) token_budget=0; budget_name="Standard" ;;
            1) token_budget=15000; budget_name="15k" ;;
            2) token_budget=30000; budget_name="30k" ;;
            *) token_budget=0; budget_name="Standard" ;;
        esac
        
        model_settings="{\"reasoning\":{\"kind\":\"budget_tokens\",\"tokens\":$token_budget}}"
        name="Claude Sonnet 4.5 ($budget_name)"
        ;;
    7) 
        model="anthropic:claude-sonnet-4-20250514"; name="Claude Sonnet 4"; color=$MAGENTA
        # Claude Sonnet 4 Token Budget Selection
        clear
        echo -e "${MAGENTA}"
        cat << "BANNER"
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘                                                           â•‘
    â•‘            CLAUDE SONNET 4 TOKEN BUDGET                   â•‘
    â•‘                                                           â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
BANNER
        echo -e "${RESET}"
        echo ""
        echo -e "${BOLD}           Select Token Budget${RESET}"
        echo ""
        echo -e "${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
        echo ""
        echo -e "  ${MAGENTA}[0]${RESET} ${BOLD}No Budget${RESET}       - Standard mode (0 tokens)"
        echo -e "  ${MAGENTA}[1]${RESET} ${BOLD}15,000 Tokens${RESET}   - Faster, lighter responses"
        echo -e "  ${MAGENTA}[2]${RESET} ${BOLD}30,000 Tokens${RESET}   - Extended thinking capacity"
        echo ""
        echo -e "${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
        echo ""
        echo -e "${DIM}Type '/exit' anytime to return to main menu${RESET}"
        echo ""
        echo -n "Token Budget: "
        read budget_choice
        
        # Check for /exit
        if [ "$budget_choice" = "/exit" ]; then
            exec "$0"
        fi
        
        case $budget_choice in
            0) token_budget=0; budget_name="Standard" ;;
            1) token_budget=15000; budget_name="15k" ;;
            2) token_budget=30000; budget_name="30k" ;;
            *) token_budget=0; budget_name="Standard" ;;
        esac
        
        model_settings="{\"reasoning\":{\"kind\":\"budget_tokens\",\"tokens\":$token_budget}}"
        name="Claude Sonnet 4 ($budget_name)"
        ;;
    12)
        exec "$0"
        ;;
    *) echo "Invalid choice"; exit 1 ;;
esac
clear

# Check if model is Claude
if echo "$model" | grep -q "claude"; then
    # Orange color for Claude
    ORANGE='\033[38;5;208m'
    echo -e "${ORANGE}"
    cat << "BANNER"
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                     â”‚
    â”‚   â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ•—â–‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ•—â–‘â–‘â–‘â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â”‚
    â”‚   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â”‚
    â”‚   â–ˆâ–ˆâ•‘â–‘â–‘â•šâ•â•â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â”‚
    â”‚   â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â”‚
    â”‚   â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â”‚
    â”‚   â–‘â•šâ•â•â•â•â•â–‘â•šâ•â•â•â•â•â•â•â•šâ•â•â–‘â–‘â•šâ•â•â–‘â•šâ•â•â•â•â•â•â–‘â•šâ•â•â•â•â•â•â–‘â•šâ•â•â•â•â•â•â•â”‚
    â”‚                                                     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
BANNER
else
    echo -e "${color}"
    cat << "BANNER"
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                     â”‚
    â”‚   â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ•—â–‘â–‘â–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—                â”‚
    â”‚   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ•â•â–ˆâ–ˆâ•”â•â•â•                â”‚
    â”‚   â–ˆâ–ˆâ•‘â–‘â–‘â•šâ•â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘                â”‚
    â”‚   â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘                â”‚
    â”‚   â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘                â”‚
    â”‚   â–‘â•šâ•â•â•â•â•â–‘â•šâ•â•â–‘â–‘â•šâ•â•â•šâ•â•â–‘â–‘â•šâ•â•â–‘â–‘â–‘â•šâ•â•â–‘â–‘â–‘                â”‚
    â”‚                                                     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
BANNER
fi
echo -e "${RESET}"
echo ""
echo -e "${BOLD}  Active Model: ${color}${name}${RESET}"
echo ""
if command -v jq > /dev/null 2>&1; then
    stats=$(cat "$STATS_FILE")
    total_msg=$(echo "$stats" | jq -r '.total_messages')
    total_tok=$(echo "$stats" | jq -r '.total_tokens')
    sessions=$(echo "$stats" | jq -r '.sessions')
    
    # Fetch credit balance
    balance=$(curl -s -X GET "$API_BASE/billing/credit-balance" \
        -H "cookie: access_token=$ACCESS_TOKEN" \
        -H "origin: https://$DOMAIN" 2>/dev/null)
    credits_cents=$(echo "$balance" | jq -r '.available_balance_cents' 2>/dev/null)
    credits_dollars=$(awk "BEGIN {printf \"%.2f\", $credits_cents / 100}" 2>/dev/null)
    
    echo -e "${DIM}  Stats: $total_msg messages â€¢ $total_tok tokens â€¢ Session #$sessions${RESET}"
    [ -n "$credits_dollars" ] && echo -e "${DIM}  Credits: ${GREEN}\$$credits_dollars${RESET}"
else
    echo -e "${DIM}  Stats: (jq not installed)${RESET}"
fi
echo ""
echo -e "${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
echo ""
echo -e "  ${CYAN}/exit${RESET}     - Exit chat"
echo -e "  ${CYAN}/stats${RESET}    - View detailed statistics"
echo -e "  ${CYAN}/reset${RESET}    - Reconfigure token"
echo ""
echo -e "${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
echo ""
while true; do
    echo -ne "${BOLD}You${RESET} â–¶ "
    read -r msg
    
    case "$msg" in
        /exit) 
            save_stats
            echo ""
            echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
            echo -e "  ${BOLD}Session Summary${RESET}"
            echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
            echo -e "  Messages: ${GREEN}$SESSION_MESSAGES${RESET}"
            echo -e "  Tokens:   ${GREEN}$SESSION_TOKENS${RESET}"
            echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
            echo ""
            exec "$0"
            ;;
        /stats)
            echo ""
            echo -e "${MAGENTA}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
            echo -e "  ${BOLD}All-Time Statistics${RESET}"
            echo -e "${MAGENTA}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
            echo -e "  Total Messages: ${GREEN}$total_msg${RESET}"
            echo -e "  Total Tokens:   ${GREEN}$total_tok${RESET}"
            echo -e "  Total Sessions: ${GREEN}$sessions${RESET}"
            echo -e "${MAGENTA}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
            echo ""
            continue
            ;;
        /reset) rm -f "$CONFIG_FILE"; exec "$0" ;;
        /horse)
            echo ""
            echo -e "${CYAN}"
            cat << 'HORSE'
                                                                         
                                     <k@$$$$$$$$$$$$$$$$_               
                   )/ckWBB@x.      ($$$$$$$$$$$$$$$$$$$@.               
                  b$$$@BBM_\@%    ~B$$$$$$$$$$$$$$$$$$$h                
                  b<[@$$$$$@L(B\. \$$$$$$$$$$$$$$$$$$@W                 
                  bvC@@$$$$$$B`Bb t$$$$$$$$$$$$$$$$$8'.                 
                  b@#. :@$$$$$@ @Ou$$$$$$@$@$$@@ot                      
                  w^m,  f@$@."\'`zm$$@.                                 
                   ..   /@$$$$$$@^@$$#                                  
                 .h$@C .@$$$$$B^h@@@@i                                  
                 lBu@W.>\B$$$$@bbkhBB                                   
                .@Y  lB@@"B$$$@@$$$$@@                                  
                &&. .@+.@$^$$@"B$$$$@XwqZ(.                             
               .8O, hQ  IBBBBn#@$$$$$$$$$$$B@B@BBi                      
                   nd        b@@@$@@@@$$$$$$$@'@$@{                     
                   [@q'         .O8'8@$$$$$$$@ $$$&                     
                     ..       "@%"@$$$$$$$$$^ $$$&                     
                             M$$@X@$$$$$@h(    $$$&                     
                             B$$$O_B$$$B       $$$&                     
                              f@@h. ?@@*       @$$&                     
                                d@j   ?B@W     YB$&                     
                              -B@"    *BJ       "@B}                    
                           .]@8    .&@C                                 
                          _Bw^    MBJ                                   
                         tttl   a@@B'                                   
                                                                         
HORSE
            echo -e "${RESET}"
            echo -e "${DIM}            The legendary Zo Computer steed${RESET}"
            echo ""
            continue
            ;;
        "") continue ;;
    esac
    
    # Paste protection
    msg_length=${#msg}
    if [ $msg_length -gt 200 ]; then
        echo ""
        echo -e "${YELLOW}âš  Large paste detected!${RESET} ${DIM}($msg_length chars)${RESET}"
        echo ""
        echo -e "${DIM}Preview:${RESET}"
        echo "${msg:0:150}..."
        echo ""
        echo -n "Send this? (y/n): "
        read confirm
        
        if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
            echo -e "${RED}âœ—${RESET} Cancelled"
            echo ""
            continue
        fi
    fi
    
    msg_esc=$(echo "$msg" | sed 's/"/\\"/g' | sed 's/\\/\\\\/g')
    
    echo ""
    
    # API request in background
    curl -s -X POST "$API_BASE/ask" \
        -H "content-type: application/json" \
        -H "cookie: access_token=$ACCESS_TOKEN" \
        -H "origin: https://$DOMAIN" \
        -d "{\"q\":\"$msg_esc\",\"model_name\":\"$model\",\"model_settings\":$model_settings,\"context_paths\":[],\"command_paths\":[]}" \
        > /tmp/zo_resp_$$ 2>/dev/null &
    
    CURL_PID=$!
    
    # EPIC loading animation
    frames=('â ‹' 'â ™' 'â ¹' 'â ¸' 'â ¼' 'â ´' 'â ¦' 'â §' 'â ‡' 'â ')
    dots=('   ' '.  ' '.. ' '...')
    i=0
    
    while kill -0 $CURL_PID 2>/dev/null; do
        dot_idx=$((i / 3 % 4))
        printf "\r  ${color}${frames[$i]}${RESET} ${BOLD}Thinking${RESET}${dots[$dot_idx]}"
        i=$(( (i + 1) % 10 ))
        sleep 0.08
    done
    
    wait $CURL_PID
    printf "\r                                                    \r"
    
    resp=$(cat /tmp/zo_resp_$$)
    rm -f /tmp/zo_resp_$$
    
    ai=$(echo "$resp" | grep -A 1 "^event: End$" | tail -1 | sed 's/^data: //' | jq -r '.data.output' 2>/dev/null)
    
    tok_line=$(echo "$resp" | grep -A 1 "^event: FrontendModelResponse$" | tail -1 | sed 's/^data: //')
    tok_in=$(echo "$tok_line" | jq -r '.input_tokens // empty' 2>/dev/null)
    tok_out=$(echo "$tok_line" | jq -r '.output_tokens // empty' 2>/dev/null)
    
    SESSION_MESSAGES=$((SESSION_MESSAGES + 1))
    
    echo -e "${color}${BOLD}AI${RESET}  â–¶ $ai"
    echo ""
    
    if [ -n "$tok_in" ] && [ "$tok_in" != "null" ] && [ "$tok_in" != "empty" ]; then
        tok_total=$((tok_in + tok_out))
        SESSION_TOKENS=$((SESSION_TOKENS + tok_total))
        
        # Create progress bar
        bar_width=30
        bar_filled=$((tok_out * bar_width / (tok_in + tok_out)))
        bar=""
        for ((j=0; j<bar_width; j++)); do
            if [ $j -lt $bar_filled ]; then
                bar+="â–ˆ"
            else
                bar+="â–‘"
            fi
        done
        
        echo -e "${DIM}      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${RESET}"
        echo -e "${DIM}      â”‚${RESET} ${GREEN}$bar${RESET} ${DIM}â”‚${RESET}"
        echo -e "${DIM}      â”‚  In: ${CYAN}$tok_in${RESET} ${DIM}â”‚ Out: ${MAGENTA}$tok_out${RESET} ${DIM}â”‚ Total: ${YELLOW}$tok_total${RESET}     ${DIM}â”‚${RESET}"
        echo -e "${DIM}      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${RESET}"
        echo ""
    fi
    
    echo -e "${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
    echo ""
done
